meta:
  id: utf8_string
seq:
  - id: codepoints
    type: utf8_codepoint

types:
  utf8_codepoint:
    seq:
      - id: byte0
        type: u1
      - id: byte1
        type: u1
        if: len_bytes >= 2
      - id: byte2
        type: u1
        if: len_bytes >= 3
      - id: byte3
        type: u1
        if: len_bytes >= 4
    instances:
      len_bytes:
        value: |
          (byte0 & 0b1000_0000 == 0) ? 1 :
          (byte0 & 0b1110_0000 == 0b1100_0000) ? 2 :
          (byte0 & 0b1111_0000 == 0b1110_0000) ? 3 :
          (byte0 & 0b1111_1000 == 0b1111_0000) ? 4 :
          -1
      value_as_int:
        value: >
          len_bytes == 1 ? (byte0 & ( len_bytes == 1 ? 0b0111_1111 : len_bytes == 2 ? 0b0001_1111 : len_bytes == 3 ? 0b0000_1111 : len_bytes == 4 ? 0b0000_0111 : 0)) :
          len_bytes == 2 ? (((byte0 & ( len_bytes == 1 ? 0b0111_1111 : len_bytes == 2 ? 0b0001_1111 : len_bytes == 3 ? 0b0000_1111 : len_bytes == 4 ? 0b0000_0111 : 0)) << 6) | (byte1 & 0b0011_1111)) :
          len_bytes == 3 ? (((byte0 & ( len_bytes == 1 ? 0b0111_1111 : len_bytes == 2 ? 0b0001_1111 : len_bytes == 3 ? 0b0000_1111 : len_bytes == 4 ? 0b0000_0111 : 0)) << 12) | ((byte1 & 0b0011_1111) << 6) | (byte2 & 0b0011_1111)) :
          len_bytes == 4 ? (((byte0 & ( len_bytes == 1 ? 0b0111_1111 : len_bytes == 2 ? 0b0001_1111 : len_bytes == 3 ? 0b0000_1111 : len_bytes == 4 ? 0b0000_0111 : 0)) << 18) | ((byte1 & 0b0011_1111) << 12) | ((byte2 & 0b0011_1111) << 6) | (byte3 & 0b0011_1111)) :
          -1
