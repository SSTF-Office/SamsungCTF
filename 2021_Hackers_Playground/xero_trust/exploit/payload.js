const GATEWAY_ID = 0;
const HISTORY_ID = 1;
const MY_ID = sessionStorage.getItem("id");
const MATE_ID = sessionStorage.getItem("mate");
const key = await import_key(sessionStorage.getItem("key").encode());

// Send some message
var plain = new Uint32Array([MY_ID, HISTORY_ID]).toUint8Array().concat("XXXXXXX".encode()).concat(new Uint32Array([HISTORY_ID, MY_ID]).toUint8Array());
await send_msg_raw(MY_ID, GATEWAY_ID, await encrypt_msg(key, plain));

// See the message
var msgs = await request_getmsg(HISTORY_ID);
var bad_header = atob(msgs[0].msg).encode().slice(16, 32);

// Indentify the message to see
var msgs = await request_getmsg(GATEWAY_ID, 0, "asc");
var original_msg = atob(msgs[0].msg).encode();
var payload = btoa(new Uint32Array([HISTORY_ID, GATEWAY_ID]).toUint8Array().concat(bad_header.concat(original_msg)).decode());
var res = await request_sendmsg(payload);

// See the secret message
var msgs = await request_getmsg(MY_ID);
var secret_msg = JSON.parse((await decrypt_msg(key, msgs[0].msg)).slice(16)).msg;

/*
the message will be
AAAAAAAA
BBBBBBBB{"msg":
"CCCCCCCCCCCCCC
DDDDDDDDDDDD"}
*/

// Make secret message payload

var part1 = new Uint32Array([MY_ID, MATE_ID]).toUint8Array().concat(JSON.stringify({"msg":secret_msg.slice(0, 14)+"XX"}).encode());
await send_msg_raw(MY_ID, GATEWAY_ID, await encrypt_msg(key, part1));
var part2 = new Uint32Array([MY_ID, MATE_ID]).toUint8Array().concat(JSON.stringify({"msg":"XXXXXXXXXXXXXX"+secret_msg.slice(14)}).encode());
await send_msg_raw(MY_ID, GATEWAY_ID, await encrypt_msg(key, part2));

var result = await request_getmsg(MATE_ID);
var first = atob(result[1].msg).slice(0,32);
var second = atob(result[0].msg).slice(32, 48);

var res = await send_msg_raw(MY_ID, MATE_ID, first.encode().concat(second.encode()));
console.log(res.flag);


