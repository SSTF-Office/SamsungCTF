# EchoFrag Writeup

## vulnerability description
[BlueFrag(CVE-2020-0022)](https://insinuator.net/2020/04/cve-2020-0022-an-android-8-0-9-0-bluetooth-zero-click-rce-bluefrag/) 의 취약점을 재현한 문제.

CVE-2020-0022의 root cause는 fragmentation 중 입력받는 packet의 크기가 header보다 크다는 가정 때문에 발생한다.
가정과 다르게 header보다 작은 크기로 packet을 보낼경우, packetsize가 음수가 되고 memcpy를 실행한다.
```c
memcpy(dest, source, size)
```
size에 음수, 예를들면 -2 (0xfffffffe in 32bit) 값이 들어가서 crash가 발생한다.


그리고 여기서 재미있는 문제가 발생한다.
다른 architecture에서는 너무 큰숫자의 memcpy를 실행하면 pagetable에 mapping되지 않은 확보되지 않은 메모리에 접근 하다가 segmentation falut가 발생하여 종료된다.

하지만 arm64(aarch64)에서는 memcpy의 최적화된 코드에서 음수와 align이 맞지않는 destination address가 주어지면 segmentation falut가 발생하지않는다.
실행되는 과정에서 일반적인 overflow와 다르게 destination address보다 작은 address에 memcpy가 원하는 값을 쓸 수 있다.

CVE-2020-0022에서는 이를 통해 echo response로 받는 size를 조절하여 ASLR code base를 leak하고 HCI handle값을 조절하기도 하여 exploit을 실행한다.

문제에서는 stack canary 및 code base 등의 주소를 leak하고, 준비된 `system("/bin/sh")`을 실행할 수 있다.

## exploit.py
큰 전략은 위에서 설명한것과 같다.

1. memcpy로 어떤 offset값이 underflow 되는지 확인
1. echo response로 보내는 size를 늘려서 stack leak
    * stack canary확인
    * ASLR 되어있는 text 영역 codebase 확인
1. stack canary를 포함하여 overflow하여 `system("/bin/sh")`를 실행하는 곳으로점프
1. shell 획득


