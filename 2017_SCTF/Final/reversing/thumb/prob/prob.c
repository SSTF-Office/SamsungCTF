#include "lib.h"

// flag{t1ny_tiny_baremetal_firmware}
#define FLAG_LEN 34
#define ITER 1000
typedef unsigned char uchar;
uchar matrix[16][16];
uchar answer[16][16] = {
    {0x3f,0xb1,0xbf,0x52,0x98,0x88,0x35,0x9d,0x29,0x3d,0xa8,0x49,0xa2,0xa8,0x4b,0xc3},
    {0xeb,0x68,0x26,0xce,0x0d,0x49,0xfe,0x08,0xcd,0x25,0x73,0x64,0x4e,0x78,0xf5,0xea},
    {0x17,0x56,0xdd,0xee,0x2f,0x4c,0xc6,0x0b,0x9c,0x05,0x40,0x8e,0x77,0x24,0xf4,0x02},
    {0xb7,0x0c,0xd2,0xad,0xed,0x08,0x18,0x2a,0xca,0xee,0xd4,0x2a,0x72,0xa6,0x13,0xc6},
    {0x58,0xf5,0x7c,0x27,0xac,0x81,0x0f,0x13,0xc7,0x14,0x4e,0xa7,0x8c,0x51,0x09,0x8a},
    {0xde,0x02,0x14,0x7e,0x9d,0x8e,0xdc,0x68,0x22,0x77,0x14,0xc4,0xf8,0xc2,0xc4,0x66},
    {0xbf,0x09,0x23,0x2f,0xd2,0x8d,0xdd,0x7f,0xa0,0xa3,0x89,0x47,0xe6,0x04,0x6b,0xfc},
    {0x87,0x32,0x48,0x0d,0xac,0x59,0x9f,0x0d,0xdd,0xcf,0x2f,0x60,0xc3,0x3d,0x36,0xcb},
    {0x23,0xb6,0x00,0x54,0x91,0x5a,0xc5,0x4a,0x7c,0x93,0xdf,0xfe,0xf5,0x1e,0x63,0xd4},
    {0x6e,0x9d,0x9b,0x85,0x63,0x44,0xfc,0xa3,0xe3,0x00,0xd4,0x22,0xb5,0xda,0xdb,0x7e},
    {0x1d,0x26,0x44,0x5e,0x12,0x58,0x39,0x84,0x6a,0x7b,0x2c,0xb3,0x4c,0x45,0x13,0x1f},
    {0xbb,0x2d,0xdf,0x95,0xc3,0xf4,0x03,0x7d,0x6e,0xb4,0xb5,0xcc,0xb7,0xea,0x0f,0x59},
    {0xcc,0xed,0x6b,0x40,0x43,0x7c,0x51,0x79,0x84,0x25,0x9a,0x4c,0xc0,0x78,0x0a,0xbf},
    {0xf6,0x2f,0x55,0x8d,0x99,0x6a,0x4b,0x33,0xbc,0xeb,0x1e,0x91,0x6b,0x52,0x32,0x0d},
    {0xfd,0x8a,0x7c,0x94,0x5f,0x01,0x2b,0xc8,0xa9,0xa8,0xb1,0xa0,0x00,0x20,0x50,0x1f},
    {0x6a,0x6e,0x2f,0x46,0xf6,0x15,0x23,0x94,0x57,0xd2,0x56,0x9c,0x9c,0x4b,0x51,0xbd},
};

void init() {
    my_srand(0xc0ffee);
    int i, j;
    for (i=0; i<16; i++)
        for (j=0; j<16; j++)
            matrix[i][j] = my_rand() % 256;
}

#ifdef DEBUG
void dump() {
    int i, j, k;
    for (i=0; i<16; i++) {
        for (j=0; j<16; j++) {
            uart_putchar('0');
            uart_putchar('x');
            printhex(matrix[i][j]);
            uart_putchar(',');
        }
        uart_putchar('\n');
    }
    uart_putchar('\n');
}
#endif

void curry() {
    int c, i, x, y;
    for (i=0; i<FLAG_LEN; i++) {
        c = uart_getchar();
        x = my_rand() % 16;
        y = my_rand() % 16;
        matrix[x][y] ^= c;
    }
}

void colswap(int a, int b) {
    uchar t;
    int i;
    for (i=0; i<16; i++) {
        t = matrix[i][a];
        matrix[i][a] = matrix[i][b];
        matrix[i][b] = t;
    }
}

void rowswap(int a, int b) {
    uchar t;
    int i;
    for (i=0; i<16; i++) {
        t = matrix[a][i];
        matrix[a][i] = matrix[b][i];
        matrix[b][i] = t;
    }
}

void ror_row(int i, int amt) {
    uchar carry = 0;
    uchar next_carry;
    uchar lomask = (1 << amt) - 1;
    int j;
    for (j=0; j<16; j++) {
        next_carry = (matrix[i][j] & lomask) << (8 - amt);
        matrix[i][j] = (matrix[i][j] >> amt) | carry;
        carry = next_carry;
    }
    matrix[i][0] |= carry;
}

void xor_box(int x, int y, unsigned char k) {
    int i, j;
    for (i=0; i<16; i++) {
        matrix[i][y] ^= k;
        matrix[x][i] ^= k;
    }
}

void c_entry() {
    init();
    uart_puts("password: ");

    curry();
    int i;
    for (i=0; i<ITER; i++) rowswap(my_rand() % 16, my_rand() % 16);
    for (i=0; i<ITER; i++) ror_row(my_rand() % 16, my_rand() % 8);
    for (i=0; i<ITER; i++) xor_box(my_rand() % 16, my_rand() % 16, my_rand() % 256);
    for (i=0; i<ITER; i++) colswap(my_rand() % 16, my_rand() % 16);

#ifdef DEBUG
    dump();
#endif
    int j;
    for (i=0; i<16; i++)
        for (j=0; j<16; j++)
            if (matrix[i][j] != answer[i][j])
                goto bad;

    uart_putchar('y');
    uart_putchar('e');
    uart_putchar('s');
    uart_putchar('!');
    uart_putchar('\n');
    return;
bad:
    uart_putchar('w');
    uart_putchar('r');
    uart_putchar('o');
    uart_putchar('n');
    uart_putchar('g');
    uart_putchar('\n');
    return;
}
