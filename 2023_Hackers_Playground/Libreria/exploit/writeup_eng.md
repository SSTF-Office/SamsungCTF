# Libreria

The server code is given together, but there is no helpful information in the config.php file. And index.php uses prepared_statement to process search queries.

res.php processes two commands, `findbyisbn` and `requestbook`, of which SQLi vulnerability exists in the process of processing `requestbook`.

```php
<?php
include "./config.php";

function err_handler($errno, $msg, $file, $line)
{
	return true;
}
set_error_handler("err_handler");

$resp_time = 3.0;

$start = microtime(true);

if (!isset($_GET['cmd'])) die;

$res = '{"res": "request failed."}';

$cmd = $_GET['cmd'];
switch($cmd) {
	case 'findbyisbn':
		if ((isset($_GET['isbn']) && strlen($_GET['isbn']) >= 10)) {
			$db = dbconnect();
			pg_prepare($db, "find_by_isbn", "SELECT * FROM books WHERE isbn=$1");
			$result = pg_execute($db, "find_by_isbn", array($_GET['isbn']));
			pg_close($db);
			if($result) {
		        $rows = pg_fetch_assoc($result);
				if ($rows) $res = json_encode($rows);
			}
		}
		break;
	case 'requestbook':
		if ((isset($_GET['isbn']) && strlen($_GET['isbn']) >= 10)) {
			$res = '{"res": "Sorry, but our budget is not enough to buy <a href=\'https://isbnsearch.org/isbn/'.$_GET['isbn'].'\'>this book</a>."}';
			$db = dbconnect();
			$result = pg_query($db, "SELECT ISBN FROM books WHERE isbn='".$_GET['isbn']."'");
			pg_close($db);
			if ($result) {
				$rows = pg_fetch_assoc($result);
				if ($rows) {
					$isbn = (int)$rows["isbn"];
					echo $rows["isbn"].'|'.$isbn;
					if (($isbn >= 1000000000) && ((string)$isbn === $rows["isbn"]))
					{
						$res = '{"res": "We already have this book('.$rows["isbn"].')."}';
					}
				}
			}
		}
		break;
	default:
		die;
}

$now = microtime(true);

if ($now - $start < $resp_time) {
	usleep((int)(($resp_time + $start - $now) * 1000000));
}

echo $res;

?>
```



This API checks whether the requested ISBN is in the DB, and returns the ISBN as it is if it exists, and the client can check the value only when the return value is in the form of an integer of 10 or more digits.

You can try Blind SQLi or configure a query so that the result of SQLi is an integer of 10 or more digits, but Blind SQLi is likely to be inefficient because the response time is at least 3 seconds.

Let's check the result of `SELECT COUNT(*) FROM INFORMATION_SCHEMA.SCHEMATA` to check the operation of SQLi.

The schema in the database is not likely to exceed 1000,000,000, so you may use `SELECT 1000000000+COUNT(*) FROM INFORMATION_SCHEMA.SCHEMATA`. The `+` symbol can be recognized as a blank when transmitted in the URL, so you can apply urlencode and change it to `%2b`.

![img1](.\img1.png)



If you create and send a query as `/rest.php?cmd=requestbook&isbn=1' union select1000000000%2bcount(*) from information_schema.schemata -- -`, you can get the json-style response value and you can see that there are a total of four schemas.

Using the `ascii` and the `substr` function, it is possible to convert strings into integer one by one and you can get them. Since it takes 3 seconds for each query, reading four letters using shift operation can save a lot of time.


As in the tutorials, flag can be obtained by obtaining schema, table name, and column information from information_schema in order and reading the table records.

